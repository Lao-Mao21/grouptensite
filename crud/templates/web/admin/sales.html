{% extends 'base/base.html' %}
{% load static %}
{% load humanize %}

{% block title %}Sales Report{% endblock title %}

{% block content %}
<div class="min-h-screen bg-gray-100 flex">
    {% include "attachments/sidebar.html" %}
    <div class="flex-1 p-4">
        <div class="max-w-7xl mx-auto">
            <div class="mb-1">
                <span id="current-date" class="text-2xl sm:text-3xl font-bold text-gray-700"></span>
                <div class="text-lg text-gray-600">Welcome back, Admin</div>
            </div>
            <div class="grid grid-cols-1 md:grid-cols-3 gap-4 mb-4 items-stretch">
                <!-- Annual Revenue Chart -->
                <div class="bg-white rounded-xl shadow-md p-3 col-span-1 md:col-span-2 flex flex-col" style="height: 270px;">
                    <div class="font-bold text-lg mb-1">Annual Revenue</div>
                    <div class="flex-1 flex items-center justify-center">
                        <canvas id="annualRevenueChart" height="140"></canvas>
                    </div>
                    <div class="flex justify-center gap-3 mt-1 text-xs">
                        <span class="text-blue-700 font-bold">■ Single</span>
                        <span class="text-green-600 font-bold">■ Double</span>
                        <span class="text-yellow-500 font-bold">■ Suite</span>
                        <span class="text-cyan-500 font-bold">■ Deluxe</span>
                    </div>
                </div>
                <!-- Monthly Top Sales Pie Chart -->
                <div class="bg-white rounded-xl shadow-md p-3 flex flex-col items-center" style="height: 270px;">
                    <div class="w-full">
                        <div class="font-bold text-lg mb-1 text-center">Monthly Top Sales</div>
                    </div>
                    <div class="flex-1 flex flex-col items-center justify-center w-full">
                        <canvas id="monthlyTopSalesChart" width="120" height="120"></canvas>
                        <!-- Legend below the chart, centered and compact -->
                        <div class="flex flex-wrap justify-center gap-2 mt-2 text-xs">
                            <span class="flex items-center gap-1">
                                <span class="text-blue-700 font-bold">■</span>
                                <span class="font-bold text-blue-700">Single</span>
                                <span class="text-gray-700 font-semibold" id="single-percentage">{{ pie_data.0 }}%</span>
                            </span>
                            <span class="flex items-center gap-1">
                                <span class="text-green-600 font-bold">■</span>
                                <span class="font-bold text-green-600">Double</span>
                                <span class="text-gray-700 font-semibold" id="double-percentage">{{ pie_data.1 }}%</span>
                            </span>
                            <span class="flex items-center gap-1">
                                <span class="text-yellow-500 font-bold">■</span>
                                <span class="font-bold text-yellow-500">Suite</span>
                                <span class="text-gray-700 font-semibold" id="suite-percentage">{{ pie_data.2 }}%</span>
                            </span>
                            <span class="flex items-center gap-1">
                                <span class="text-cyan-500 font-bold">■</span>
                                <span class="font-bold text-cyan-500">Deluxe</span>
                                <span class="text-gray-700 font-semibold" id="deluxe-percentage">{{ pie_data.3 }}%</span>
                            </span>
                        </div>
                    </div>
                    <!-- Pagination always at the bottom, inside the card -->
                    <div class="flex justify-center items-center gap-1 mt-2">
                        <button class="rounded-full p-1 bg-gray-100 hover:bg-gray-200">
                            <span class="material-icons text-base align-middle">arrow_back</span>
                        </button>
                        <button class="rounded-full p-1 bg-gray-100 hover:bg-gray-200">
                            <span class="material-icons text-base align-middle">arrow_forward</span>
                        </button>
                    </div>
                </div>
            </div>
            <!-- Daily Sales Table -->
            <div class="bg-white rounded-xl shadow-md p-3 mt-2">
                <div class="flex justify-between items-center mb-1">
                    <div>
                        <div class="font-bold text-lg">Month of {{ current_month_name }}</div>
                        <div class="text-xs text-gray-500">Daily Sales</div>
                    </div>
                    <form method="get" class="flex items-center">
                        <input type="text" name="search" placeholder="Search" class="px-2 py-1 border rounded-l-md text-xs focus:outline-none focus:ring-2 focus:ring-blue-500">
                        <button type="submit" class="px-2 py-1 bg-blue-700 text-white rounded-r-md hover:bg-blue-800">
                            <span class="material-icons align-middle text-base">search</span>
                        </button>
                    </form>
                </div>
                <div class="overflow-x-auto">
                    <table class="min-w-full bg-white border border-gray-200 text-xs">
                        <thead class="bg-gray-100">
                            <tr>
                                <th class="px-2 py-1 border font-bold">Day</th>
                                <th class="px-2 py-1 border font-bold">Total Booking</th>
                                <th class="px-2 py-1 border font-bold">Total Cancellation</th>
                                <th class="px-2 py-1 border font-bold">Refunded</th>
                                <th class="px-2 py-1 border font-bold">Total Sales</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for report in sales_report %}
                            <tr>
                                <td class="px-2 py-1 border">{{ report.day }}</td>
                                <td class="px-2 py-1 border">{{ report.total_booking }}</td>
                                <td class="px-2 py-1 border">{{ report.total_cancellation }}</td>
                                <td class="px-2 py-1 border">₱{{ report.refunded|floatformat:2|intcomma }}</td>
                                <td class="px-2 py-1 border">₱{{ report.total_sales|floatformat:2|intcomma }}</td>
                            </tr>
                            {% empty %}
                            <tr>
                                <td colspan="7" class="text-center py-2 px-4 border text-gray-500">No sales data found.</td>
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
                <div class="flex justify-center items-center gap-1 mt-1">
                    {% if sales_report.has_previous %}
                        <a href="?page={{ sales_report.previous_page_number }}" class="p-1 border rounded-full hover:bg-blue-100">
                            <span class="material-icons text-base text-center align-middle">arrow_back</span>
                        </a>
                    {% endif %}
                    {% for num in sales_report.paginator.page_range %}
                        {% if sales_report.number == num %}
                            <span class="px-2 py-1 bg-blue-600 text-white rounded">{{ num }}</span>
                        {% else %}
                            <a href="?page={{ num }}" class="px-2 py-1 border rounded hover:bg-blue-100">{{ num }}</a>
                        {% endif %}
                    {% endfor %}
                    {% if sales_report.has_next %}
                        <a href="?page={{ sales_report.next_page_number }}" class="p-1 border rounded-full hover:bg-blue-100">
                            <span class="material-icons text-base text-center align-middle">arrow_forward</span>
                        </a>
                    {% endif %}
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Chart Data -->
{{ months|safe|json_script:"months-data" }}
{{ annual_data|safe|json_script:"annual-data" }}
{{ pie_data|safe|json_script:"pie-data" }}

{% endblock content %}