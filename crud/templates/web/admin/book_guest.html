{% extends 'base/base.html' %}
{% load static %}

{% block title %}Book Guest{% endblock title %}

{% block content %}
<!-- Add Flatpickr CSS -->
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/flatpickr/dist/flatpickr.min.css">
<!-- Add Flatpickr JS -->
<script src="https://cdn.jsdelivr.net/npm/flatpickr"></script>

<div class="min-h-screen bg-gray-200 flex sm:flex-row flex-col">
    {% include "attachments/sidebar.html" %}
    <div class="flex-1 p-2 sm:p-8">
        <!-- Booking Form -->
        <div class="max-w-5xl h-fit mx-auto bg-gray-100 rounded-xl shadow-md p-6">
            <form method="post" action="{% url 'book_guest' %}" class="space-y-4" id="booking-form">
                {% csrf_token %}
                <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                    <!-- Guest Name -->
                    <div>
                        <label class="block text-sm font-medium text-gray-700">Guest Name *</label>
                        <select name="full_name" id="guest-select" required
                                class="mt-1 px-4 py-2 block w-full rounded-md bg-white border-gray-300 shadow-sm focus:border-blue-500 focus:ring-blue-500">
                            <option value="">Select Guest</option>
                            {% for guest in all_guests %}
                            <option value="{{ guest.full_name }}" 
                                    data-gender="{{ guest.gender }}"
                                    data-contact="{{ guest.phone_number }}"
                                    data-nationality="{{ guest.nationality|default:'' }}"
                                    data-address="{{ guest.address|default:'' }}">
                                {{ guest.full_name }}
                            </option>
                            {% endfor %}
                        </select>
                    </div>

                    <!-- Gender -->
                    <div>
                        <label class="block text-sm font-medium text-gray-700">Gender *</label>
                        <input type="text" name="gender" id="gender-select" required readonly
                               class="mt-1 px-4 py-2 block w-full rounded-md bg-white border-gray-300 shadow-sm focus:border-blue-500 focus:ring-blue-500">
                    </div>

                    <!-- Contact Number -->
                    <div>
                        <label class="block text-sm font-medium text-gray-700">Contact Number *</label>
                        <input type="tel" name="contact_number" id="contact-input" required readonly
                               class="mt-1 px-4 py-2 block w-full rounded-md bg-white border-gray-300 shadow-sm focus:border-blue-500 focus:ring-blue-500">
                    </div>

                    <!-- Nationality -->
                    <div>
                        <label class="block text-sm font-medium text-gray-700">Nationality *</label>
                        <input type="text" name="nationality" id="nationality-input" required readonly
                               class="mt-1 px-4 py-2 block w-full rounded-md bg-white border-gray-300 shadow-sm focus:border-blue-500 focus:ring-blue-500">
                    </div>

                    <!-- Address -->
                    <div class="md:col-span-2">
                        <label class="block text-sm font-medium text-gray-700">Address *</label>
                        <input type="text" name="address" id="address-input" required readonly
                               class="mt-1 px-4 py-2 block w-full rounded-md bg-white border-gray-300 shadow-sm focus:border-blue-500 focus:ring-blue-500">
                    </div>

                    <!-- Booking Type -->
                    <div class="md:col-span-1">
                        <label class="block text-sm font-medium text-gray-700">Booking Type *</label>
                        <select name="booking_type" id="booking-type" required
                                class="mt-1 px-4 py-2 block w-full rounded-md bg-white border-gray-300 shadow-sm focus:border-blue-500 focus:ring-blue-500">
                            <option value="">Select Booking Type</option>
                            <option value="immediate">Immediate Check-in</option>
                            <option value="reservation">Future Reservation</option>
                        </select>
                    </div>

                    <!-- Expected Arrival -->
                    <div id="expected-arrival-container" style="display: none;">
                        <label class="block text-sm font-medium text-gray-700">Expected Arrival *</label>
                        <input type="datetime-local" name="expected_arrival" id="expected-arrival"
                               class="mt-1 px-4 py-2 block w-full rounded-md bg-white border-gray-300 shadow-sm focus:border-blue-500 focus:ring-blue-500">
                    </div>
                    <input type="hidden" name="expected_arrival" id="expected-arrival-hidden">

                    <!-- Room Number and Type -->
                    <div class="md:col-span-1">
                        <label class="block text-sm font-medium text-gray-700">Room Number & Type *</label>
                        <select name="room_number" id="room-number" required 
                                class="mt-1 px-4 py-2 block w-full rounded-md bg-white border-gray-300 shadow-sm focus:border-blue-500 focus:ring-blue-500">
                            <option value="">Select Available Room</option>
                            {% for room in available_rooms %}
                            <option value="{{ room.room_id }}" data-room-type="{{ room.room_type }}">
                                {{ room.room_number }} - {{ room.room_type }}
                            </option>
                            {% empty %}
                            <option value="" disabled>No rooms available at the moment</option>
                            {% endfor %}
                        </select>
                        <p class="mt-1 px-4 py-2 text-sm text-gray-500">
                            {% if available_rooms %}
                            Select from {{ available_rooms|length }} available room{{ available_rooms|length|pluralize }}
                            {% else %}
                            All rooms are currently occupied or reserved
                            {% endif %}
                        </p>
                    </div>

                    <!-- Number of Guests -->
                    <div>
                        <label class="block text-sm font-medium text-gray-700">Number of Guest *</label>
                        <input type="number" name="guest_count" id="guest-count" required min="1"
                               class="mt-1 px-4 py-2 block w-full rounded-md bg-white border-gray-300 shadow-sm focus:border-blue-500 focus:ring-blue-500">
                    </div>

                    <!-- Check In -->
                    <div>
                        <label class="block text-sm font-medium text-gray-700">Check In *</label>
                        <input type="datetime-local" name="check_in" id="check-in" required
                               class="mt-1 px-4 py-2 block w-full rounded-md bg-white border-gray-300 shadow-sm focus:border-blue-500 focus:ring-blue-500">
                    </div>

                    <!-- Check Out -->
                    <div>
                        <label class="block text-sm font-medium text-gray-700">Check Out *</label>
                        <input type="datetime-local" name="check_out" id="check-out" required
                               class="mt-1 px-4 py-2 block w-full rounded-md bg-white border-gray-300 shadow-sm focus:border-blue-500 focus:ring-blue-500">
                    </div>
                    
                    <!-- Payment Status -->
                    <div>
                        <label class="block text-sm font-medium text-gray-700">Payment Status *</label>
                        <select name="payment_status" required
                                class="mt-1 px-4 py-2 block w-full rounded-md bg-white border-gray-300 shadow-sm focus:border-blue-500 focus:ring-blue-500">
                            <option value="">Select</option>
                            <option value="pending" {% if guest.payment_status == "pending" %}selected{% endif %}>Pending</option>
                            <option value="paid" {% if guest.payment_status == "paid" %}selected{% endif %}>Paid</option>
                            <option value="refunded" {% if guest.payment_status == "refunded" %}selected{% endif %}>Refunded</option>
                            <option value="cancelled" {% if guest.payment_status == "cancelled" %}selected{% endif %}>Cancelled</option>
                        </select>
                    </div>

                    <!-- Mode of Payment -->
                    <div>
                        <label class="block text-sm font-medium text-gray-700">Mode of Payment *</label>
                        <select name="payment_mode" required 
                                class="mt-1 px-4 py-2 block w-full rounded-md bg-white border-gray-300 shadow-sm focus:border-blue-500 focus:ring-blue-500">
                            <option value="">Select</option>
                            <option value="cash">Cash</option>
                            <option value="card">Credit/Debit Card</option>
                            <option value="gcash">GCash</option>
                        </select>
                    </div>
                </div>

                <div class="flex justify-end mt-6 space-x-3">
                    <a href="{% url 'manage_guests' %}" 
                       class="px-6 py-2 bg-gray-100 text-gray-700 font-semibold rounded-md hover:bg-gray-200 focus:outline-none focus:ring-2 focus:ring-gray-500 focus:ring-offset-2">
                        Cancel
                    </a>
                    <button type="submit" 
                            class="px-6 py-2 bg-green-600 text-white font-semibold rounded-md hover:bg-green-700 focus:outline-none focus:ring-2 focus:ring-green-500 focus:ring-offset-2">
                        Book Now
                    </button>
                </div>
            </form>
        </div>
    </div>
</div>

<!-- Form handling script -->
<script>
document.addEventListener('DOMContentLoaded', function() {
    const form = document.getElementById('booking-form');
    const guestSelect = document.getElementById('guest-select');
    const genderSelect = document.getElementById('gender-select');
    const contactInput = document.getElementById('contact-input');
    const nationalityInput = document.getElementById('nationality-input');
    const addressInput = document.getElementById('address-input');
    const bookingType = document.getElementById('booking-type');
    const expectedArrivalContainer = document.getElementById('expected-arrival-container');
    
    // Function to update guest details
    function updateGuestDetails(selectedOption) {
        if (selectedOption && selectedOption.value) {
            // Fill in the form fields with data from the selected option
            genderSelect.value = selectedOption.dataset.gender || '';
            contactInput.value = selectedOption.dataset.contact || '';
            nationalityInput.value = selectedOption.dataset.nationality || '';
            addressInput.value = selectedOption.dataset.address || '';
        } else {
            // Clear all fields if no guest is selected
            genderSelect.value = '';
            contactInput.value = '';
            nationalityInput.value = '';
            addressInput.value = '';
        }
    }

    // Add change event listener to guest select
    if (guestSelect) {
        guestSelect.addEventListener('change', function() {
            const selectedOption = this.options[this.selectedIndex];
            updateGuestDetails(selectedOption);
        });

        // Trigger the change event if a guest is already selected
        if (guestSelect.value) {
            const selectedOption = guestSelect.options[guestSelect.selectedIndex];
            updateGuestDetails(selectedOption);
        }
    }

    // Common config for date/time pickers
    const dateConfig = {
        enableTime: true,
        dateFormat: "Y-m-d H:i",
        minDate: "today",
        time_24hr: true
    };

    // Initialize Expected Arrival picker
    const expectedArrivalPicker = flatpickr("#expected-arrival", {
        ...dateConfig,
        onChange: function(selectedDates) {
            // Update min date for check-in
            checkInPicker.set('minDate', selectedDates[0]);
        }
    });

    // Initialize Check In picker
    const checkInPicker = flatpickr("#check-in", {
        ...dateConfig,
        onChange: function(selectedDates) {
            // Update min date for check-out
            checkOutPicker.set('minDate', selectedDates[0]);
        }
    });

    // Initialize Check Out picker
    const checkOutPicker = flatpickr("#check-out", {
        ...dateConfig,
        minDate: new Date()
    });

    // Handle booking type changes
    bookingType.addEventListener('change', function() {
        const isReservation = this.value === 'reservation';
        
        // Show/hide expected arrival field
        expectedArrivalContainer.style.display = isReservation ? 'block' : 'none';
        const expectedArrival = document.getElementById('expected-arrival');
        expectedArrival.required = isReservation;

        // Update check-in constraints
        if (isReservation) {
            // For reservations, allow future dates
            checkInPicker.set('minDate', 'today');
        } else {
            // For immediate bookings, only allow today and set expected arrival to check-in time
            const today = new Date();
            checkInPicker.set('minDate', today);
            checkInPicker.set('maxDate', today);
            checkInPicker.setDate(today);
            // Set expected arrival to same as check-in for immediate bookings
            expectedArrival.value = today.toISOString().slice(0, 16);
        }
    });

    // Handle form submission
    form.addEventListener('submit', function(e) {
        e.preventDefault(); // Prevent form submission until we validate

        // Create an array of required fields with their display names
        const requiredFields = [
            { id: 'guest-select', name: 'Guest Name' },
            { id: 'gender-select', name: 'Gender' },
            { id: 'contact-input', name: 'Contact Number' },
            { id: 'nationality-input', name: 'Nationality' },
            { id: 'address-input', name: 'Address' },
            { id: 'booking-type', name: 'Booking Type' },
            { id: 'room-number', name: 'Room' },
            { id: 'guest-count', name: 'Number of Guest' },
            { id: 'check-in', name: 'Check-in Date' },
            { id: 'check-out', name: 'Check-out Date' }
        ];

        // Check all required fields
        let isValid = true;
        for (const field of requiredFields) {
            const element = document.getElementById(field.id);
            if (!element || !element.value.trim()) {
                alert(`Please fill in ${field.name}`);
                if (element) element.focus();
                isValid = false;
                return;
            }
        }

        // Check payment mode
        const paymentMode = document.querySelector('select[name="payment_mode"]');
        if (!paymentMode || !paymentMode.value) {
            alert('Please select Payment Mode');
            paymentMode.focus();
            isValid = false;
            return;
        }

        const isReservation = bookingType.value === 'reservation';
        
        // Check reservation-specific fields
        if (isReservation) {
            const expectedArrival = document.getElementById('expected-arrival');
            if (!expectedArrival || !expectedArrival.value.trim()) {
                alert('Expected arrival is required for reservations');
                expectedArrival.focus();
                isValid = false;
                return;
            }
        }

        // Validate check-in and check-out dates
        const checkInDate = new Date(document.getElementById('check-in').value);
        const checkOutDate = new Date(document.getElementById('check-out').value);
        
        if (checkOutDate <= checkInDate) {
            alert('Check-out must be after check-in');
            document.getElementById('check-out').focus();
            isValid = false;
            return;
        }

        // Validate guest count is a number
        const guestCount = document.getElementById('guest-count').value.trim();
        if (isNaN(guestCount) || guestCount < 1) {
            alert('Please enter a valid number of guests');
            document.getElementById('guest-count').focus();
            isValid = false;
            return;
        }

        // For immediate bookings, set expected arrival to check-in time
        if (!isReservation) {
            const expectedArrival = document.getElementById('expected-arrival');
            expectedArrival.value = document.getElementById('check-in').value;
        }

        if (isValid) {
            // Add room type to hidden input
            const selectedRoom = document.getElementById('room-number');
            const selectedOption = selectedRoom.options[selectedRoom.selectedIndex];
            const roomType = selectedOption.dataset.roomType;
            
            let roomTypeInput = form.querySelector('input[name="room_type"]');
            if (!roomTypeInput) {
                roomTypeInput = document.createElement('input');
                roomTypeInput.type = 'hidden';
                roomTypeInput.name = 'room_type';
                form.appendChild(roomTypeInput);
            }
            roomTypeInput.value = roomType;

            // Submit the form
            form.submit();
        }
    });
});
</script>
{% endblock content %} 