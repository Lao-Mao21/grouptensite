{% extends 'base/base_web.html' %}
{% load static %}

{% block title %}Book a Room{% endblock title %}

{% block extra_head %}
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css">
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/flatpickr/dist/flatpickr.min.css">
<script src="https://cdn.jsdelivr.net/npm/flatpickr"></script>
<script src="https://js.stripe.com/v3/"></script>
<style>
  body {
    font-family: 'Inter', -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif;
  }
  .font-heading {
    font-family: 'Inter', -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif;
    font-weight: 600;
  }
  .room-card {
    transition: transform 0.2s ease, box-shadow 0.2s ease;
  }
  .room-card:hover {
    transform: translateY(-2px);
    box-shadow: 0 8px 16px rgba(0,0,0,0.1);
  }
  .room-card button:not(:disabled) {
    cursor: pointer;
  }
  .room-card button:disabled {
    opacity: 0.5;
    cursor: not-allowed;
  }
  .back-button {
    transition: transform 0.2s ease;
  }
  .back-button:hover {
    transform: translateX(-2px);
  }
  
  /* Login Modal Styles */
  .modal {
    display: none;
    position: fixed;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    background-color: rgba(0, 0, 0, 0.5);
    z-index: 1000;
  }
  
  .modal.show {
    display: flex;
    align-items: center;
    justify-content: center;
  }
  
  .modal-content {
    animation: slideIn 0.3s ease-out;
  }
  
  @keyframes slideIn {
    from {
      transform: translateY(-20px);
      opacity: 0;
    }
    to {
      transform: translateY(0);
      opacity: 1;
    }
  }

  /* Stripe Elements styling */
  .StripeElement {
    box-sizing: border-box;
    height: 40px;
    padding: 10px 12px;
    border: 1px solid #e2e8f0;
    border-radius: 0.5rem;
    background-color: white;
    transition: box-shadow 150ms ease;
  }

  .StripeElement--focus {
    box-shadow: 0 0 0 2px #f97316;
    border-color: #f97316;
  }

  .StripeElement--invalid {
    border-color: #ef4444;
  }

  .StripeElement--webkit-autofill {
    background-color: #fefde5 !important;
  }
</style>
{% endblock %}

{% block content %}
<div class="min-h-screen bg-gray-50 py-8">
  <!-- Back Button -->
  <div class="max-w-4xl mx-auto mb-6">
    <a href="{% url 'landing_page' %}" class="back-button inline-flex items-center text-gray-600 hover:text-gray-900">
      <svg class="w-5 h-5 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10 19l-7-7m0 0l7-7m-7 7h18"/>
      </svg>
      Back to Home
    </a>
  </div>

  <!-- Progress Bar -->
  <div class="max-w-4xl mx-auto mb-8">
    <div class="w-2/3 h-1 bg-gray-200 mx-auto">
      <div class="h-full bg-orange-500 transition-all duration-300" style="width: 33%;"></div>
    </div>
  </div>

  <!-- Step 1: Choose Room -->
  <div id="step1" class="step-content">
    <div class="max-w-6xl mx-auto">
      <h2 class="text-center text-2xl font-heading font-semibold mb-8">Choose your room</h2>
      <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
        {% for room in available_rooms %}
        <div class="room-card bg-white p-4 rounded-lg shadow-md">
          <div class="relative">
            <img src="{{ MEDIA_URL }}{{ room.room_type|lower }}.jpg" 
                 alt="{{ room.get_room_type_display }}" 
                 class="w-full h-64 object-cover rounded-lg mb-3">
            {% if room.room_status != 'available' %}
            <div class="absolute inset-0 bg-black bg-opacity-50 rounded-lg flex items-center justify-center">
              <span class="text-white font-medium px-3 py-1 bg-red-500 rounded-full text-sm">
                Currently Unavailable
              </span>
            </div>
            {% endif %}
          </div>
          
          <div class="text-center">
            <div class="bg-orange-500 text-white text-sm py-1 px-4 rounded-full inline-block mb-2 font-medium">
              {{ room.get_room_type_display }}
            </div>
            <p class="text-gray-700 font-medium mb-2">
              ₱{{ room.room_price|floatformat:2 }}
            </p>
            
            <div class="mb-4">
              {% if room.room_status == 'available' %}
              <span class="text-green-600 text-sm font-medium">
                Room {{ room.room_number }} Available
              </span>
              {% else %}
              <span class="text-red-600 text-sm font-medium">
                Not Available
              </span>
              {% endif %}
            </div>
            
            <button type="button"
                    data-room-id="{{ room.room_id }}"
                    data-room-type="{{ room.room_type }}"
                    data-room-number="{{ room.room_number }}"
                    data-room-name="{{ room.get_room_type_display }}"
                    data-room-price="{{ room.room_price }}"
                    class="select-room-btn w-full px-4 py-2 {% if room.room_status == 'available' %}bg-orange-500 hover:bg-orange-600{% else %}bg-gray-300{% endif %} text-white rounded-lg transition-colors font-medium"
                    {% if room.room_status != 'available' %}disabled{% endif %}>
              {% if room.room_status == 'available' %}
                Select Room
                
              {% else %}
                Not Available
              {% endif %}
            </button>
          </div>
        </div>
        {% empty %}
        <div class="col-span-2 text-center py-8">
          <div class="text-gray-500 text-lg">No rooms are currently available.</div>
          <p class="text-gray-400 mt-2">Please check back later or contact us for assistance.</p>
        </div>
        {% endfor %}
      </div>
    </div>
  </div>

  <!-- Step 2: Booking Details -->
  <div id="step2" class="step-content hidden">
    <div class="max-w-2xl mx-auto bg-white rounded-lg shadow-md p-6">
      <h2 class="text-center text-2xl font-heading font-semibold mb-6">Booking Details</h2>
      <form id="bookingForm" class="space-y-4">
        {% csrf_token %}
        <!-- Hidden fields for room data -->
        <input type="hidden" id="selected_room_id" name="room_id">
        <input type="hidden" id="selected_room_price" name="room_price">
        
        <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
          <!-- Left Column -->
          <div>
            <label class="block text-sm font-medium mb-1">Full Name <span class="text-red-500">*</span></label>
            <input type="text" name="full_name" required 
                   class="w-full px-3 py-2 border rounded-lg focus:ring-2 focus:ring-orange-500 focus:border-orange-500 outline-none bg-gray-50"
                   value="{{ guest_account.full_name }}" readonly>
          </div>
          <div>
            <label class="block text-sm font-medium mb-1">Gender <span class="text-red-500">*</span></label>
            <input type="text" name="gender" required 
                   class="w-full px-3 py-2 border rounded-lg focus:ring-2 focus:ring-orange-500 focus:border-orange-500 outline-none bg-gray-50"
                   value="{{ guest_account.gender }}" readonly>
          </div>
          <div>
            <label class="block text-sm font-medium mb-1">Contact Number <span class="text-red-500">*</span></label>
            <input type="tel" name="contact_number" required 
                   class="w-full px-3 py-2 border rounded-lg focus:ring-2 focus:ring-orange-500 focus:border-orange-500 outline-none bg-gray-50"
                   value="{{ guest_account.phone_number }}" readonly>
          </div>
          <div>
            <label class="block text-sm font-medium mb-1">Nationality <span class="text-red-500">*</span></label>
            <input type="text" name="nationality" required 
                   class="w-full px-3 py-2 border rounded-lg focus:ring-2 focus:ring-orange-500 focus:border-orange-500 outline-none bg-gray-50"
                   value="{{ guest_account.nationality }}" readonly>
          </div>
          <div class="col-span-2">
            <label class="block text-sm font-medium mb-1">Address <span class="text-red-500">*</span></label>
            <input type="text" name="address" required 
                   class="w-full px-3 py-2 border rounded-lg focus:ring-2 focus:ring-orange-500 focus:border-orange-500 outline-none bg-gray-50"
                   value="{{ guest_account.address }}" readonly>
          </div>
          <div>
            <label class="block text-sm font-medium mb-1">Room Number & Type <span class="text-red-500">*</span></label>
            <select name="room_number" id="room-select" required class="w-full px-3 py-2 border rounded-lg focus:ring-2 focus:ring-orange-500 focus:border-orange-500 outline-none">
              <option value="">Select Available Room</option>
              {% for room in available_rooms %}
                <option value="{{ room.room_id }}" 
                        data-room-type="{{ room.room_type }}"
                        data-price="{{ room.room_price }}"
                        data-price-type="per day/night">
                  Room {{ room.room_number }} - {{ room.get_room_type_display }} (₱{{ room.room_price|floatformat:2 }})
                </option>
              {% endfor %}
            </select>
          </div>
          <div>
            <label class="block text-sm font-medium mb-1">Number of Guests <span class="text-red-500">*</span></label>
            <select name="guest_count" required class="w-full px-3 py-2 border rounded-lg focus:ring-2 focus:ring-orange-500 focus:border-orange-500 outline-none">
              <option value="">Select</option>
              <option value="1">1</option>
              <option value="2">2</option>
              <option value="3">3</option>
              <option value="4">4</option>
            </select>
          </div>
          <div>
            <label class="block text-sm font-medium mb-1">Check IN <span class="text-red-500">*</span></label>
            <input type="text" name="check_in" required 
                   class="datepicker w-full px-3 py-2 border rounded-lg focus:ring-2 focus:ring-orange-500 focus:border-orange-500 outline-none"
                   placeholder="Select date and time">
          </div>
          <div>
            <label class="block text-sm font-medium mb-1">Check OUT <span class="text-red-500">*</span></label>
            <input type="text" name="check_out" required 
                   class="datepicker w-full px-3 py-2 border rounded-lg focus:ring-2 focus:ring-orange-500 focus:border-orange-500 outline-none"
                   placeholder="Select date and time">
          </div>
          <div>
            <label class="block text-sm font-medium mb-1">Expected Arrival <span class="text-red-500">*</span></label>
            <input type="text" name="expected_arrival" required 
                   class="datepicker w-full px-3 py-2 border rounded-lg focus:ring-2 focus:ring-orange-500 focus:border-orange-500 outline-none"
                   placeholder="Select date and time">
          </div>
        </div>

        <!-- Buttons -->
        <div class="flex justify-between mt-6">
          <button type="button" onclick="prevStep()" class="px-8 py-2 bg-red-500 text-white rounded-lg hover:bg-red-600">
            Back
          </button>
          <button type="button" onclick="validateAndProceed()" class="px-8 py-2 bg-orange-500 text-white rounded-lg hover:bg-orange-600">
            Next
          </button>
        </div>
      </form>
    </div>
  </div>

  <!-- Step 3: Payment -->
  <div id="step3" class="step-content hidden">
    <div class="max-w-md mx-auto bg-white rounded-lg shadow-md p-6">
      <h2 class="text-center text-2xl font-medium mb-6">Payment Information</h2>
      <form id="paymentForm" class="space-y-4">
        {% csrf_token %}
        
        <!-- Mode of Payment -->
        <div>
          <label class="block text-sm font-medium mb-1">Mode of Payment <span class="text-red-500">*</span></label>
          <select id="paymentMode" name="payment_mode" required class="w-full px-3 py-2 border rounded-lg focus:ring-2 focus:ring-orange-500 focus:border-orange-500 outline-none">
            <option value="credit_card">Credit Card</option>
          </select>
        </div>

        <!-- Card holder name -->
        <div>
          <label class="block text-sm font-medium mb-1">Card Holder Name <span class="text-red-500">*</span></label>
          <input type="text" id="cardName" name="card_name" placeholder="Name on card"
                 class="w-full px-3 py-2 border rounded-lg focus:ring-2 focus:ring-orange-500 focus:border-orange-500 outline-none" required>
        </div>

        <!-- Billing address -->
        <div>
          <label class="block text-sm font-medium mb-1">Billing Address <span class="text-red-500">*</span></label>
          <input type="text" id="billingAddress" name="billing_address" placeholder="One, Two, Three"
                 class="w-full px-3 py-2 border rounded-lg focus:ring-2 focus:ring-orange-500 focus:border-orange-500 outline-none"
                 value="{{ guest_account.address }}" required>
        </div>

        <!-- Card Number -->
        <div>
          <label class="block text-sm font-medium mb-1">Card Number <span class="text-red-500">*</span></label>
          <div class="relative">
            <input type="text" id="card-number" name="card_number" required
                   class="w-full px-3 py-2 border rounded-lg focus:ring-2 focus:ring-orange-500 focus:border-orange-500 outline-none"
                   placeholder="1234 5678 9012 3456">
            <div class="absolute right-3 top-1/2 transform -translate-y-1/2 flex space-x-2">
              <i class="fa-brands fa-cc-visa text-gray-400 text-xl"></i>
              <i class="fa-brands fa-cc-mastercard text-gray-400 text-xl"></i>
              <i class="fa-brands fa-cc-amex text-gray-400 text-xl"></i>
            </div>
          </div>
        </div>

        <div class="grid grid-cols-2 gap-4">
          <!-- Expiry Date -->
          <div>
            <label class="block text-sm font-medium mb-1">Expiry Date <span class="text-red-500">*</span></label>
            <input type="text" id="card-expiry" name="card_expiry" required
                   class="w-full px-3 py-2 border rounded-lg focus:ring-2 focus:ring-orange-500 focus:border-orange-500 outline-none"
                   placeholder="MM/YY">
          </div>

          <!-- CVV -->
          <div>
            <label class="block text-sm font-medium mb-1">CVV <span class="text-red-500">*</span></label>
            <input type="text" id="card-cvv" name="card_cvv" required
                   class="w-full px-3 py-2 border rounded-lg focus:ring-2 focus:ring-orange-500 focus:border-orange-500 outline-none"
                   placeholder="123" maxlength="4">
          </div>
        </div>

        <div id="card-errors" class="mt-2 text-sm text-red-600" role="alert"></div>

        <!-- Total Amount -->
        <div class="text-right border-t pt-4 mt-4">
          <div class="font-medium">Total Amount</div>
          <div class="text-xl">₱ <span id="finalAmount">0.00</span></div>
        </div>

        <!-- Action Buttons -->
        <div class="flex justify-between mt-6">
          <button type="button" onclick="prevStep()" class="px-8 py-2 bg-red-500 text-white rounded-lg hover:bg-red-600">
            Back
          </button>
          <button type="submit" id="submit-button" class="px-8 py-2 bg-green-500 text-white rounded-lg hover:bg-green-600">
            Pay now
          </button>
        </div>
      </form>
    </div>
  </div>

  <!-- Step 4: Success -->
  <div id="step4" class="step-content hidden">
    <div class="max-w-md mx-auto bg-white rounded-lg shadow-md p-8 text-center">
      <div class="w-16 h-16 bg-green-100 rounded-full flex items-center justify-center mx-auto mb-4">
        <svg class="w-8 h-8 text-green-500" fill="none" stroke="currentColor" viewBox="0 0 24 24">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"></path>
        </svg>
      </div>
      <h2 class="text-2xl font-bold text-green-500 mb-2">Congratulations!</h2>
      <p class="text-gray-600 mb-6">Your Room Reservation is Confirmed</p>
      <p class="text-sm text-gray-500 mb-6">Please check your email for the reservation details and check-in instructions.</p>
      <a href="{% url 'landing_page' %}" class="inline-block px-8 py-2 bg-green-500 text-white rounded-full hover:bg-green-600">
        Home
      </a>
    </div>
  </div>
</div>
{% endblock %}

{% block scripts %}
<script>
let currentStep = 1;
const totalSteps = 4;
let selectedRoom = null;
let roomPrice = 0;

// Function to check room availability
async function checkRoomAvailability(roomData, checkIn = null, checkOut = null) {
  try {
    // Construct URL with proper encoding
    let url = `/check-room-availability/${roomData.type}/${roomData.number}/`;
    if (checkIn && checkOut) {
      const params = new URLSearchParams({
        check_in: checkIn,
        check_out: checkOut
      });
      url += `?${params.toString()}`;
    }
    
    const response = await fetch(url);
    if (!response.ok) {
      throw new Error(`HTTP error! status: ${response.status}`);
    }
    
    const data = await response.json();
    
    if (!data.success) {
      throw new Error(data.message || 'Room is not available');
    }
    
    return data.room_status === 'available';
  } catch (error) {
    console.error('Error checking room availability:', error);
    alert(error.message || 'Error checking room availability. Please try again.');
    return false;
  }
}

function updateProgress() {
  const progressBar = document.querySelector('.bg-orange-500');
  const progress = ((currentStep) / totalSteps) * 100;
  progressBar.style.width = `${progress}%`;
}

function showStep(step) {
  document.querySelectorAll('.step-content').forEach(content => {
    content.classList.add('hidden');
  });
  document.getElementById(`step${step}`).classList.remove('hidden');
  currentStep = step;
  updateProgress();
}

async function selectRoom(roomData) {
  try {
    // Show loading state
    const button = document.querySelector(`[data-room-id="${roomData.id}"]`);
    const originalText = button.innerHTML;
    button.disabled = true;
    button.innerHTML = '<span class="inline-block animate-spin mr-2">↻</span> Checking...';
    
    // Check availability before proceeding
    const isAvailable = await checkRoomAvailability({
      type: roomData.type,
      number: roomData.number
    });
    
    if (!isAvailable) {
      button.innerHTML = 'Not Available';
      setTimeout(() => {
        button.innerHTML = originalText;
        button.disabled = false;
      }, 2000);
      return;
    }
    
    selectedRoom = roomData;
    roomPrice = parseFloat(roomData.price);
    
    // Update room select dropdown
    const roomSelect = document.getElementById('room-select');
    if (roomSelect) {
      roomSelect.value = roomData.id;
      const selectedOption = roomSelect.options[roomSelect.selectedIndex];
      if (selectedOption) {
        roomPrice = parseFloat(selectedOption.dataset.price);
      }
    }
    
    // Update hidden fields
    document.getElementById('selected_room_id').value = roomData.id;
    document.getElementById('selected_room_price').value = roomPrice;
    
    calculateTotal();
    nextStep();
    
    // Reset button state
    button.innerHTML = originalText;
    button.disabled = false;
  } catch (error) {
    console.error('Error selecting room:', error);
    alert('Error selecting room. Please try again.');
    
    // Reset button state
    const button = document.querySelector(`[data-room-id="${roomData.id}"]`);
    if (button) {
      button.innerHTML = 'Select Room';
      button.disabled = false;
    }
  }
}

function calculateTotal() {
  try {
    const checkInInput = document.querySelector('input[name="check_in"]');
    const checkOutInput = document.querySelector('input[name="check_out"]');
    
    if (checkInInput && checkOutInput && selectedRoom) {
      const checkIn = new Date(checkInInput.value);
      const checkOut = new Date(checkOutInput.value);
      
      if (!isNaN(checkIn) && !isNaN(checkOut) && roomPrice) {
        const days = Math.ceil((checkOut - checkIn) / (1000 * 60 * 60 * 24));
        if (days <= 0) {
          document.getElementById('finalAmount').textContent = '0.00';
          return;
        }
        const total = days * roomPrice;
        document.getElementById('finalAmount').textContent = total.toFixed(2);
      }
    }
  } catch (error) {
    console.error('Error calculating total:', error);
  }
}

function nextStep() {
  if (currentStep < totalSteps) {
    currentStep++;
    showStep(currentStep);
  }
}

function prevStep() {
  if (currentStep > 1) {
    currentStep--;
    showStep(currentStep);
  }
}

async function validateAndProceed() {
  try {
    const form = document.getElementById('bookingForm');
    
    // Check if a room is selected
    if (!selectedRoom) {
      alert('Please select a room first');
      return;
    }
    
    // Get form data
    const checkIn = form.querySelector('[name="check_in"]').value;
    const checkOut = form.querySelector('[name="check_out"]').value;
    const guestCount = form.querySelector('[name="guest_count"]').value;
    const expectedArrival = form.querySelector('[name="expected_arrival"]').value;
    
    // Validate required fields
    if (!checkIn || !checkOut || !guestCount || !expectedArrival) {
      alert('Please fill in all required fields');
      return;
    }
    
    // Show loading state
    const nextButton = form.querySelector('button[onclick="validateAndProceed()"]');
    const originalText = nextButton.innerHTML;
    nextButton.disabled = true;
    nextButton.innerHTML = '<span class="inline-block animate-spin mr-2">↻</span> Checking...';
    
    try {
      // Check room availability for selected dates
      const isAvailable = await checkRoomAvailability({
        type: selectedRoom.type,
        number: selectedRoom.number
      }, checkIn, checkOut);
      
      if (!isAvailable) {
        alert('Room is no longer available for the selected dates');
        nextButton.innerHTML = originalText;
        nextButton.disabled = false;
        return;
      }
      
      // Store booking details
      const bookingDetails = {
        room_id: selectedRoom.id,
        room_type: selectedRoom.type,
        room_number: selectedRoom.number,
        room_price: roomPrice,
        check_in: checkIn,
        check_out: checkOut,
        guest_count: guestCount,
        expected_arrival: expectedArrival,
        total_amount: document.getElementById('finalAmount').textContent
      };
      sessionStorage.setItem('bookingDetails', JSON.stringify(bookingDetails));
      
      nextStep();
    } finally {
      // Reset button state
      nextButton.innerHTML = originalText;
      nextButton.disabled = false;
    }
  } catch (error) {
    console.error('Error validating form:', error);
    alert('Error validating form. Please try again.');
  }
}

// Initialize on page load
document.addEventListener('DOMContentLoaded', function() {
  updateProgress();

  // Add click handlers for room selection buttons
  document.querySelectorAll('.select-room-btn').forEach(button => {
    button.addEventListener('click', function() {
      if (!this.disabled) {
        const roomData = {
          id: this.dataset.roomId,
          type: this.dataset.roomType,
          number: this.dataset.roomNumber,
          name: this.dataset.roomName,
          price: parseFloat(this.dataset.roomPrice)
        };
        selectRoom(roomData);
      }
    });
  });

  // Initialize Flatpickr
  const today = new Date();
  const tomorrow = new Date(today);
  tomorrow.setDate(tomorrow.getDate() + 1);

  // Common configuration
  const commonConfig = {
    enableTime: true,
    dateFormat: "Y-m-d H:i",
    time_24hr: false,
    minuteIncrement: 30,
    disableMobile: true,
    allowInput: true
  };

  // Check-in picker
  const checkInPicker = flatpickr('input[name="check_in"]', {
    ...commonConfig,
    minDate: "today",
    defaultDate: today,
    onChange: function(selectedDates) {
      if (selectedDates[0]) {
        const minCheckOut = new Date(selectedDates[0]);
        minCheckOut.setHours(minCheckOut.getHours() + 1);
        
        checkOutPicker.set('minDate', minCheckOut);
        expectedArrivalPicker.set('maxDate', selectedDates[0]);
        
        if (checkOutPicker.selectedDates[0] <= selectedDates[0]) {
          checkOutPicker.setDate(minCheckOut);
        }
        
        calculateTotal();
      }
    }
  });

  // Check-out picker
  const checkOutPicker = flatpickr('input[name="check_out"]', {
    ...commonConfig,
    minDate: tomorrow,
    defaultDate: tomorrow,
    onChange: function() {
      calculateTotal();
    }
  });

  // Expected arrival picker
  const expectedArrivalPicker = flatpickr('input[name="expected_arrival"]', {
    ...commonConfig,
    minDate: "today",
    maxDate: checkInPicker.selectedDates[0] || today,
    defaultDate: today
  });

  // Room select change handler
  const roomSelect = document.getElementById('room-select');
  if (roomSelect) {
    roomSelect.addEventListener('change', function() {
      const selectedOption = this.options[this.selectedIndex];
      if (selectedOption.value) {
        roomPrice = parseFloat(selectedOption.dataset.price);
        calculateTotal();
      }
    });
  }

  // Initialize payment form handlers
  initializePaymentForm();
});

function initializePaymentForm() {
  // Card number formatting
  const cardNumber = document.getElementById('card-number');
  cardNumber.addEventListener('input', function(e) {
    let value = e.target.value.replace(/\D/g, '');
    if (value.length > 16) value = value.slice(0, 16);
    let formattedValue = '';
    for (let i = 0; i < value.length; i++) {
      if (i > 0 && i % 4 === 0) formattedValue += ' ';
      formattedValue += value[i];
    }
    e.target.value = formattedValue;
  });

  // Expiry date formatting
  const cardExpiry = document.getElementById('card-expiry');
  cardExpiry.addEventListener('input', function(e) {
    let value = e.target.value.replace(/\D/g, '');
    if (value.length > 4) value = value.slice(0, 4);
    if (value.length > 2) {
      value = value.slice(0, 2) + '/' + value.slice(2);
    }
    e.target.value = value;
  });

  // CVV input
  const cardCvv = document.getElementById('card-cvv');
  cardCvv.addEventListener('input', function(e) {
    let value = e.target.value.replace(/\D/g, '');
    if (value.length > 4) value = value.slice(0, 4);
    e.target.value = value;
  });

  // Payment form submission
  const form = document.getElementById('paymentForm');
  const submitButton = document.getElementById('submit-button');
  const errorElement = document.getElementById('card-errors');

  form.addEventListener('submit', async function(event) {
    event.preventDefault();
    
    try {
      submitButton.disabled = true;
      submitButton.innerHTML = '<span class="inline-block animate-spin mr-2">↻</span> Processing...';
      errorElement.textContent = '';
      
      // Get stored booking details
      const bookingDetails = JSON.parse(sessionStorage.getItem('bookingDetails'));
      
      // Check room availability one last time
      const isAvailable = await checkRoomAvailability({
        type: bookingDetails.room_type,
        number: bookingDetails.room_number
      }, bookingDetails.check_in, bookingDetails.check_out);
      
      if (!isAvailable) {
        throw new Error('Room is no longer available');
      }
      
      // Get form data
      const formData = {
        booking_id: bookingDetails.room_id,
        card_data: {
          number: document.getElementById('card-number').value.replace(/\s/g, ''),
          expiry: document.getElementById('card-expiry').value,
          cvv: document.getElementById('card-cvv').value,
          card_holder: document.getElementById('cardName').value,
          billing_address: document.getElementById('billingAddress').value
        },
        booking_details: {
          check_in: bookingDetails.check_in,
          check_out: bookingDetails.check_out,
          guest_count: parseInt(bookingDetails.guest_count),
          expected_arrival: bookingDetails.expected_arrival
        }
      };

      const response = await fetch('/process-payment/', {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json',
          'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]').value
        },
        body: JSON.stringify(formData)
      });
      
      const data = await response.json();
      
      if (!data.success) {
        throw new Error(data.error || 'Payment failed');
      }
      
      // Clear booking details
      sessionStorage.removeItem('bookingDetails');
      
      // Show success step
      nextStep();
      
    } catch (error) {
      errorElement.textContent = error.message;
      submitButton.disabled = false;
      submitButton.innerHTML = 'Pay now';
      
      if (error.message.includes('no longer available')) {
        setTimeout(() => {
          window.location.reload();
        }, 2000);
      }
    }
  });
}
</script>
{% endblock %}