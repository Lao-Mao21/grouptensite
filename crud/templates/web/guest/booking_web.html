{% extends 'base/base_web.html' %}

{% block title %}Book a Room{% endblock title %}

{% block extra_head %}
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css">
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/flatpickr/dist/flatpickr.min.css">
<style>
  body {
    font-family: 'Inter', -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif;
  }
  .font-heading {
    font-family: 'Inter', -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif;
    font-weight: 600;
  }
  .room-card {
    transition: transform 0.2s ease, box-shadow 0.2s ease;
  }
  .room-card:hover {
    transform: translateY(-2px);
    box-shadow: 0 8px 16px rgba(0,0,0,0.1);
  }
  .room-card button:not(:disabled) {
    cursor: pointer;
  }
  .room-card button:disabled {
    opacity: 0.5;
    cursor: not-allowed;
  }
  .back-button {
    transition: transform 0.2s ease;
  }
  .back-button:hover {
    transform: translateX(-2px);
  }
  
  /* Login Modal Styles */
  .modal {
    display: none;
    position: fixed;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    background-color: rgba(0, 0, 0, 0.5);
    z-index: 1000;
  }
  
  .modal.show {
    display: flex;
    align-items: center;
    justify-content: center;
  }
  
  .modal-content {
    animation: slideIn 0.3s ease-out;
  }
  
  @keyframes slideIn {
    from {
      transform: translateY(-20px);
      opacity: 0;
    }
    to {
      transform: translateY(0);
      opacity: 1;
    }
  }
</style>
{% endblock %}

{% block content %}
<div class="min-h-screen bg-gray-50 py-8">
  <!-- Back Button -->
  <div class="max-w-4xl mx-auto mb-6">
    <a href="{% url 'landing_page' %}" class="back-button inline-flex items-center text-gray-600 hover:text-gray-900">
      <svg class="w-5 h-5 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10 19l-7-7m0 0l7-7m-7 7h18"/>
      </svg>
      Back to Home
    </a>
  </div>

  <!-- Progress Bar -->
  <div class="max-w-4xl mx-auto mb-8">
    <div class="w-2/3 h-1 bg-gray-200 mx-auto">
      <div class="h-full bg-orange-500 transition-all duration-300" style="width: 33%;"></div>
    </div>
  </div>

  <!-- Step 1: Choose Room -->
  <div id="step1" class="step-content">
    <div class="max-w-4xl mx-auto">
      <h2 class="text-center text-2xl font-heading font-semibold mb-8">Choose your room</h2>
      <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
        {% for room_type in room_types %}
        <div class="room-card bg-white p-4 rounded-lg shadow-md">
          <div class="relative">
            <img src="{{ MEDIA_URL }}{{ room_type.image }}" alt="{{ room_type.name }}" 
                 class="w-full h-48 object-cover rounded-lg mb-3">
            {% if room_type.available == 0 %}
            <div class="absolute inset-0 bg-black bg-opacity-50 rounded-lg flex items-center justify-center">
              <span class="text-white font-medium px-3 py-1 bg-red-500 rounded-full text-sm">
                Currently Unavailable
              </span>
            </div>
            {% endif %}
          </div>
          
          <div class="text-center">
            <div class="bg-{{ room_type.id|lower }} text-white text-sm py-1 px-4 rounded-full inline-block mb-2 font-medium">
              {{ room_type.name|upper }}
            </div>
            <p class="text-gray-700 font-medium mb-2">
              ₱{{ room_type.price|floatformat:2 }} - ₱{{ room_type.max_price|floatformat:2 }}
            </p>
            
            <div class="mb-4">
              {% if room_type.available > 0 %}
              <span class="text-green-600 text-sm font-medium">
                {{ room_type.available }} room{{ room_type.available|pluralize }} available
              </span>
              {% else %}
              <span class="text-red-600 text-sm font-medium">
                No rooms available
              </span>
              {% endif %}
            </div>
            
            <button type="button"
                    onclick="selectRoom('{{ room_type.id }}', '{{ room_type.name }}', {{ room_type.price }})"
                    class="w-full px-4 py-2 bg-orange-500 text-white rounded-lg hover:bg-orange-600 transition-colors font-medium {% if room_type.available == 0 %}opacity-50{% endif %}"
                    {% if room_type.available == 0 %}disabled{% endif %}
                    title="{% if room_type.available == 0 %}This room type is currently unavailable{% else %}Select this room{% endif %}">
              Select Room
            </button>
          </div>
        </div>
        {% endfor %}
      </div>
    </div>
  </div>

  <!-- Step 2: Booking Details -->
  <div id="step2" class="step-content hidden">
    <div class="max-w-2xl mx-auto bg-white rounded-lg shadow-md p-6">
      <h2 class="text-center text-2xl font-heading font-semibold mb-6">Booking Details</h2>
      <form id="bookingForm" class="space-y-4">
        {% csrf_token %}
        <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
          <!-- Left Column -->
          <div>
            <label class="block text-sm font-medium mb-1">Full Name <span class="text-red-500">*</span></label>
            <input type="text" name="full_name" required 
                   class="w-full px-3 py-2 border rounded-lg focus:ring-2 focus:ring-orange-500 focus:border-orange-500 outline-none bg-gray-50"
                   value="{{ guest_account.full_name }}" readonly>
          </div>
          <div>
            <label class="block text-sm font-medium mb-1">Gender <span class="text-red-500">*</span></label>
            <select name="gender" required class="w-full px-3 py-2 border rounded-lg focus:ring-2 focus:ring-orange-500 focus:border-orange-500 outline-none bg-gray-50" disabled>
              <option value="">Select</option>
              <option value="Male" {% if guest_account.gender == 'Male' %}selected{% endif %}>Male</option>
              <option value="Female" {% if guest_account.gender == 'Female' %}selected{% endif %}>Female</option>
              <option value="Other" {% if guest_account.gender == 'Other' %}selected{% endif %}>Other</option>
            </select>
            <input type="hidden" name="gender" value="{{ guest_account.gender }}">
          </div>
          <div>
            <label class="block text-sm font-medium mb-1">Contact Number <span class="text-red-500">*</span></label>
            <input type="tel" name="contact_number" required 
                   class="w-full px-3 py-2 border rounded-lg focus:ring-2 focus:ring-orange-500 focus:border-orange-500 outline-none bg-gray-50"
                   value="{{ guest_account.phone_number }}" readonly>
          </div>
          <div>
            <label class="block text-sm font-medium mb-1">Nationality <span class="text-red-500">*</span></label>
            <select name="nationality" required class="w-full px-3 py-2 border rounded-lg focus:ring-2 focus:ring-orange-500 focus:border-orange-500 outline-none bg-gray-50" disabled>
              <option value="">Select</option>
              <option value="Filipino" {% if guest_account.nationality == 'Filipino' %}selected{% endif %}>Filipino</option>
              <option value="Other" {% if guest_account.nationality == 'Other' %}selected{% endif %}>Other</option>
            </select>
            <input type="hidden" name="nationality" value="{{ guest_account.nationality }}">
          </div>
          <div class="col-span-2">
            <label class="block text-sm font-medium mb-1">Address <span class="text-red-500">*</span></label>
            <input type="text" name="address" required 
                   class="w-full px-3 py-2 border rounded-lg focus:ring-2 focus:ring-orange-500 focus:border-orange-500 outline-none bg-gray-50"
                   value="{{ guest_account.address }}" readonly>
          </div>
          <div>
            <label class="block text-sm font-medium mb-1">Room Number & Type <span class="text-red-500">*</span></label>
            <div class="relative">
              <select name="room_number" id="room-select" required class="w-full px-3 py-2 border rounded-lg focus:ring-2 focus:ring-orange-500 focus:border-orange-500 outline-none">
                <option value="">Select Available Room</option>
                {% for room in available_rooms %}
                  <option value="{{ room.room_id }}" 
                          data-room-type="{{ room.room_type }}"
                          data-price="{{ room.room_price }}"
                          data-price-type="{{ room.room_price_type }}">
                    Room {{ room.room_number }} - {{ room.get_room_type_display }}
                  </option>
                {% empty %}
                  <option value="" disabled>No rooms available at the moment</option>
                {% endfor %}
              </select>
              <p class="mt-1 text-sm text-gray-500">
                {% if available_rooms %}
                  Available rooms: {{ available_rooms|length }}
                {% else %}
                  All rooms are currently occupied or reserved
                {% endif %}
              </p>
            </div>
          </div>
          <div>
            <label class="block text-sm font-medium mb-1">Number of Guests <span class="text-red-500">*</span></label>
            <select name="guest_count" required class="w-full px-3 py-2 border rounded-lg focus:ring-2 focus:ring-orange-500 focus:border-orange-500 outline-none">
              <option value="">Select</option>
              <option value="1">1</option>
              <option value="2">2</option>
              <option value="3">3</option>
              <option value="4">4</option>
            </select>
          </div>
          <div>
            <label class="block text-sm font-medium mb-1">Check IN <span class="text-red-500">*</span></label>
            <input type="datetime-local" name="check_in" required 
                   class="flatpickr w-full px-3 py-2 border rounded-lg focus:ring-2 focus:ring-orange-500 focus:border-orange-500 outline-none">
          </div>
          <div>
            <label class="block text-sm font-medium mb-1">Check OUT <span class="text-red-500">*</span></label>
            <input type="datetime-local" name="check_out" required 
                   class="flatpickr w-full px-3 py-2 border rounded-lg focus:ring-2 focus:ring-orange-500 focus:border-orange-500 outline-none">
          </div>
          <div>
            <label class="block text-sm font-medium mb-1">Expected Arrival <span class="text-red-500">*</span></label>
            <input type="datetime-local" name="expected_arrival" required 
                   class="flatpickr w-full px-3 py-2 border rounded-lg focus:ring-2 focus:ring-orange-500 focus:border-orange-500 outline-none">
          </div>
        </div>

        <!-- Buttons -->
        <div class="flex justify-between mt-6">
          <button type="button" onclick="prevStep()" class="px-8 py-2 bg-red-500 text-white rounded hover:bg-red-600">
            Back
          </button>
          <button type="button" onclick="validateAndProceed()" class="px-8 py-2 bg-orange-500 text-white rounded hover:bg-orange-600">
            Next
          </button>
        </div>
      </form>
    </div>
  </div>

  <!-- Step 3: Payment -->
  <div id="step3" class="step-content hidden">
    <div class="max-w-md mx-auto bg-white rounded-lg shadow-md p-6">
      <h2 class="text-center text-xl font-medium mb-6">Payment Information</h2>
      <form id="paymentForm" class="space-y-4">
        {% csrf_token %}
        
        <!-- Payment Mode Selection -->
        <div>
          <label class="block text-sm font-medium mb-1">Credit Card Payment <span class="text-red-500">*</span></label>
          <div class="payment-mode-btn flex items-center justify-center p-4 border rounded-lg border-orange-500 bg-orange-50">
            <div class="flex space-x-2">
              <i class="fab fa-cc-visa text-blue-600 text-2xl"></i>
              <i class="fab fa-cc-mastercard text-red-500 text-2xl"></i>
              <i class="fab fa-cc-amex text-blue-400 text-2xl"></i>
            </div>
          </div>
          <input type="hidden" name="payment_mode" id="payment_mode" value="credit_card" required>
        </div>

        <!-- Credit Card Fields -->
        <div id="credit_card_fields" class="space-y-4">
          <div>
            <label class="block text-sm font-medium mb-1">Card Holder Name <span class="text-red-500">*</span></label>
            <input type="text" name="card_name" placeholder="Name on card"
                   class="w-full px-3 py-2 border rounded-lg focus:ring-2 focus:ring-orange-500 focus:border-orange-500 outline-none" required>
          </div>
          <div>
            <label class="block text-sm font-medium mb-1">Billing Address <span class="text-red-500">*</span></label>
            <input type="text" name="billing_address" placeholder="Billing Address"
                   class="w-full px-3 py-2 border rounded-lg focus:ring-2 focus:ring-orange-500 focus:border-orange-500 outline-none"
                   value="{{ guest_account.address }}" required>
          </div>
          <div class="relative">
            <label class="block text-sm font-medium mb-1">Card Number <span class="text-red-500">*</span></label>
            <input type="text" name="card_number" placeholder="1234 5678 9012 3456"
                   class="w-full pl-3 pr-24 py-2 border rounded-lg focus:ring-2 focus:ring-orange-500 focus:border-orange-500 outline-none"
                   pattern="[0-9\s]{19}" maxlength="19" oninput="formatCardNumber(this)" required>
            <div class="absolute right-3 top-[38px] transform -translate-y-1/2 flex items-center space-x-1">
              <i class="fab fa-cc-visa text-blue-600 text-xl"></i>
              <i class="fab fa-cc-mastercard text-red-500 text-xl"></i>
              <i class="fab fa-cc-amex text-blue-400 text-xl"></i>
            </div>
          </div>
          <div class="flex gap-4">
            <div class="relative">
              <label class="block text-sm font-medium mb-1">Expiry Date <span class="text-red-500">*</span></label>
              <input type="text" name="expiry" placeholder="MM/YY"
                     class="w-24 pl-3 pr-8 py-2 border rounded-lg focus:ring-2 focus:ring-orange-500 focus:border-orange-500 outline-none"
                     pattern="(0[1-9]|1[0-2])\/([0-9]{2})" maxlength="5" oninput="formatExpiryDate(this)" required>
              <div class="absolute right-2 top-[38px] transform -translate-y-1/2">
                <i class="far fa-calendar text-gray-400"></i>
              </div>
            </div>
            <div class="relative">
              <label class="block text-sm font-medium mb-1">CVV <span class="text-red-500">*</span></label>
              <input type="text" name="cvv" placeholder="123"
                     class="w-20 pl-3 pr-8 py-2 border rounded-lg focus:ring-2 focus:ring-orange-500 focus:border-orange-500 outline-none"
                     pattern="[0-9]{3,4}" maxlength="4" required>
              <div class="absolute right-2 top-[38px] transform -translate-y-1/2">
                <i class="fas fa-lock text-gray-400"></i>
              </div>
            </div>
          </div>
        </div>

        <!-- Total Amount -->
        <div class="text-right border-t pt-4 mt-4">
          <div class="font-medium">Total Amount</div>
          <div class="text-xl">₱ <span id="finalAmount">0.00</span></div>
        </div>

        <!-- Action Buttons -->
        <div class="flex justify-between mt-6">
          <button type="button" onclick="prevStep()" class="px-8 py-2 bg-red-500 text-white rounded hover:bg-red-600">
            Cancel
          </button>
          <button type="submit" class="px-8 py-2 bg-green-500 text-white rounded hover:bg-green-600">
            Pay now
          </button>
        </div>
      </form>
    </div>
  </div>

  <!-- Step 4: Success -->
  <div id="step4" class="step-content hidden">
    <div class="max-w-md mx-auto bg-white rounded-lg shadow-md p-8 text-center">
      <div class="w-16 h-16 bg-green-100 rounded-full flex items-center justify-center mx-auto mb-4">
        <svg class="w-8 h-8 text-green-500" fill="none" stroke="currentColor" viewBox="0 0 24 24">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"></path>
        </svg>
      </div>
      <h2 class="text-2xl font-bold text-green-500 mb-2">Congratulations!</h2>
      <p class="text-gray-600 mb-6">You've Successfully Booked a Room</p>
      <a href="{% url 'landing_page' %}" class="inline-block px-8 py-2 bg-green-500 text-white rounded-full hover:bg-green-600">
        Home
      </a>
    </div>
  </div>
</div>
{% endblock %}

{% block scripts %}
<script src="https://cdn.jsdelivr.net/npm/flatpickr"></script>
<script>
let currentStep = 1;
const totalSteps = 4;
let selectedRoom = null;
let roomPrice = 0;

function updateProgress() {
  const progressBar = document.querySelector('.bg-orange-500');
  const progress = ((currentStep) / totalSteps) * 100;
  progressBar.style.width = `${progress}%`;
}

function showStep(step) {
  document.querySelectorAll('.step-content').forEach(content => {
    content.classList.add('hidden');
  });
  document.getElementById(`step${step}`).classList.remove('hidden');
  currentStep = step;
  updateProgress();
}

// Update room selection handling
document.addEventListener('DOMContentLoaded', function() {
  const roomSelect = document.getElementById('room-select');
  if (roomSelect) {
    roomSelect.addEventListener('change', function() {
      const selectedOption = this.options[this.selectedIndex];
      if (selectedOption && selectedOption.value) {
        selectedRoom = selectedOption.value;
        roomPrice = parseFloat(selectedOption.dataset.price) || 0;
        
        // Update booking title with room type
        const bookingTitle = document.querySelector('#step2 h2');
        if (bookingTitle) {
          const roomType = selectedOption.dataset.roomType;
          bookingTitle.textContent = `Booking ${roomType} Room`;
        }
        
        // Store room type in hidden input
        let roomTypeInput = document.querySelector('input[name="room_type"]');
        if (!roomTypeInput) {
          roomTypeInput = document.createElement('input');
          roomTypeInput.type = 'hidden';
          roomTypeInput.name = 'room_type';
          document.getElementById('bookingForm').appendChild(roomTypeInput);
        }
        roomTypeInput.value = selectedOption.dataset.roomType;
        
        // Calculate total price
        calculateTotal();
      }
    });
  }
  
  // Add event listeners for check-in/out dates
  const checkInInput = document.querySelector('input[name="check_in"]');
  const checkOutInput = document.querySelector('input[name="check_out"]');
  
  if (checkInInput && checkOutInput) {
    checkInInput.addEventListener('change', calculateTotal);
    checkOutInput.addEventListener('change', calculateTotal);
  }
});

function calculateTotal() {
  const checkInInput = document.querySelector('input[name="check_in"]');
  const checkOutInput = document.querySelector('input[name="check_out"]');
  const roomSelect = document.getElementById('room-select');
  
  if (checkInInput && checkOutInput && roomSelect.value) {
    const checkIn = new Date(checkInInput.value);
    const checkOut = new Date(checkOutInput.value);
    const selectedOption = roomSelect.options[roomSelect.selectedIndex];
    const roomPrice = parseFloat(selectedOption.dataset.price);
    const priceType = selectedOption.dataset.priceType;
    
    let total = 0;
    if (priceType === 'per hour') {
      const hours = Math.ceil((checkOut - checkIn) / (1000 * 60 * 60));
      total = hours * roomPrice;
    } else if (priceType === 'per day/night') {
      const days = Math.ceil((checkOut - checkIn) / (1000 * 60 * 60 * 24));
      total = days * roomPrice;
    } else {
      // For custom price type, use the base price
      total = roomPrice;
    }
    
    // Update the total amount display
    const finalAmountElement = document.getElementById('finalAmount');
    if (finalAmountElement) {
      finalAmountElement.textContent = total.toFixed(2);
    }
  }
}

function selectRoom(roomId, roomName, price) {
  console.log('Selected room type:', roomId); // Debug log
  selectedRoom = roomId;
  roomPrice = parseFloat(price);
  
  // Update room numbers dropdown
  const roomSelect = document.getElementById('room-select');
  if (roomSelect) {
    console.log('Total options:', roomSelect.options.length); // Debug log
    
    // Filter options to show only rooms of selected type
    Array.from(roomSelect.options).forEach(option => {
      if (option.value === '') return; // Skip the placeholder option
      console.log('Option:', option.value, option.dataset.roomType); // Debug log
      
      if (option.dataset.roomType === roomId) {
        option.style.display = '';
      } else {
        option.style.display = 'none';
      }
    });
    
    // Select the first available room of this type
    const firstAvailableRoom = Array.from(roomSelect.options).find(
      option => option.dataset.roomType === roomId
    );
    if (firstAvailableRoom) {
      firstAvailableRoom.selected = true;
      roomSelect.dispatchEvent(new Event('change'));
    }
  }
  
  // Update booking title
  const bookingTitle = document.querySelector('#step2 h2');
  if (bookingTitle) {
    bookingTitle.textContent = `Booking ${roomName} Room`;
  }
  
  // Calculate initial total
  calculateTotal();
  
  // Proceed to next step
  nextStep();
}

function nextStep() {
  if (currentStep < totalSteps) {
    currentStep++;
    showStep(currentStep);
  }
}

function prevStep() {
  if (currentStep > 1) {
    currentStep--;
    showStep(currentStep);
  }
}

function validateAndProceed() {
  const form = document.getElementById('bookingForm');
  if (form.checkValidity()) {
    // Get guest account data
    const guestData = {
      full_name: form.querySelector('[name="full_name"]').value,
      gender: form.querySelector('[name="gender"]').value,
      contact_number: form.querySelector('[name="contact_number"]').value,
      nationality: form.querySelector('[name="nationality"]').value,
      address: form.querySelector('[name="address"]').value,
      room_id: selectedRoom,
      guest_count: form.querySelector('[name="guest_count"]').value,
      check_in: form.querySelector('[name="check_in"]').value,
      check_out: form.querySelector('[name="check_out"]').value,
      expected_arrival: form.querySelector('[name="expected_arrival"]').value
    };

    // Store guest data for payment step
    sessionStorage.setItem('bookingData', JSON.stringify(guestData));
    calculateTotal(); // Recalculate total before proceeding
    nextStep();
  } else {
    form.reportValidity();
  }
}

function formatCardNumber(input) {
  // Remove any non-digit characters
  let value = input.value.replace(/\D/g, '');
  
  // Add spaces after every 4 digits
  value = value.replace(/(\d{4})(?=\d)/g, '$1 ');
  
  // Update the input value
  input.value = value;
  
  // Update card type icons
  const cardNumber = value.replace(/\s/g, '');
  const visaIcon = document.querySelector('.fa-cc-visa');
  const mastercardIcon = document.querySelector('.fa-cc-mastercard');
  const amexIcon = document.querySelector('.fa-cc-amex');
  
  // Reset all icons to low opacity
  [visaIcon, mastercardIcon, amexIcon].forEach(icon => {
    if (icon) icon.style.opacity = '0.3';
  });
  
  // Highlight the correct icon based on card number
  if (/^4/.test(cardNumber)) {
    visaIcon.style.opacity = '1';
  } else if (/^5[1-5]/.test(cardNumber)) {
    mastercardIcon.style.opacity = '1';
  } else if (/^3[47]/.test(cardNumber)) {
    amexIcon.style.opacity = '1';
  }
}

function formatExpiryDate(input) {
  let value = input.value.replace(/\D/g, '');
  if (value.length >= 2) {
    value = value.slice(0, 2) + '/' + value.slice(2);
  }
  input.value = value.slice(0, 5);
}

function validatePaymentForm() {
  const form = document.getElementById('paymentForm');
  
  // Card number validation (16 digits)
  const cardNumber = form.card_number.value.replace(/\s/g, '');
  if (!/^\d{16}$/.test(cardNumber)) {
    alert('Please enter a valid 16-digit card number');
    return false;
  }
  
  // Expiry date validation (MM/YY format)
  const expiry = form.expiry.value;
  if (!/^(0[1-9]|1[0-2])\/([0-9]{2})$/.test(expiry)) {
    alert('Please enter a valid expiry date (MM/YY)');
    return false;
  }
  
  // CVV validation (3-4 digits)
  const cvv = form.cvv.value;
  if (!/^[0-9]{3,4}$/.test(cvv)) {
    alert('Please enter a valid CVV (3-4 digits)');
    return false;
  }
  
  return true;
}

document.getElementById('paymentForm').addEventListener('submit', function(event) {
  event.preventDefault();
  
  if (validatePaymentForm()) {
    // Show loading state
    const submitBtn = this.querySelector('button[type="submit"]');
    submitBtn.disabled = true;
    submitBtn.innerHTML = '<span class="inline-block animate-spin mr-2">↻</span> Processing...';
    
    // Get form data
    const formData = new FormData();
    formData.append('room_id', document.getElementById('room-select').value);
    formData.append('check_in', document.querySelector('input[name="check_in"]').value);
    formData.append('check_out', document.querySelector('input[name="check_out"]').value);
    formData.append('guest_count', document.querySelector('select[name="guest_count"]').value);
    formData.append('payment_mode', 'credit_card');
    formData.append('card_number', this.card_number.value.replace(/\s/g, ''));
    formData.append('card_name', this.card_name.value);
    formData.append('expiry', this.expiry.value);
    formData.append('cvv', this.cvv.value);
    formData.append('csrfmiddlewaretoken', document.querySelector('[name=csrfmiddlewaretoken]').value);
    
    // Send payment data to server
    fetch(window.location.href, {
      method: 'POST',
      body: formData,
      headers: {
        'X-Requested-With': 'XMLHttpRequest'
      }
    })
    .then(response => response.json())
    .then(data => {
      if (data.success) {
        // Store payment info for confirmation
        sessionStorage.setItem('card_last_four', this.cvv.value);
        nextStep();
      } else {
        alert(data.error || 'Payment failed. Please try again.');
        submitBtn.disabled = false;
        submitBtn.innerHTML = 'Pay now';
      }
    })
    .catch(error => {
      console.error('Error:', error);
      alert('An error occurred. Please try again.');
      submitBtn.disabled = false;
      submitBtn.innerHTML = 'Pay now';
    });
  }
});

document.addEventListener('DOMContentLoaded', function() {
  updateProgress();
  
  // Initialize Flatpickr for all datetime inputs
  const dateConfig = {
    enableTime: true,
    dateFormat: "Y-m-d H:i",
    minDate: "today",
    time_24hr: true
  };

  // Initialize check-in with base configuration
  const checkInPicker = flatpickr('input[name="check_in"]', {
    ...dateConfig,
    onChange: function(selectedDates) {
      // Update check-out min date when check-in changes
      checkOutPicker.set('minDate', selectedDates[0]);
    }
  });

  // Initialize check-out with additional min date constraint
  const checkOutPicker = flatpickr('input[name="check_out"]', {
    ...dateConfig,
    minDate: document.querySelector('input[name="check_in"]').value || "today"
  });

  // Initialize expected arrival
  flatpickr('input[name="expected_arrival"]', dateConfig);

  // Set readonly fields to a different background color
  document.querySelectorAll('input[readonly]').forEach(input => {
    input.classList.add('bg-gray-50');
  });

  // Set select elements with pre-filled values to readonly-like state
  document.querySelectorAll('select').forEach(select => {
    if (select.value) {
      select.classList.add('bg-gray-50');
      select.setAttribute('disabled', 'disabled');
    }
  });

  // Format expiry date input
  const expiryInput = document.querySelector('input[name="expiry"]');
  if (expiryInput) {
    expiryInput.addEventListener('input', function(e) {
      let value = e.target.value.replace(/\D/g, '');
      if (value.length >= 2) {
        value = value.slice(0, 2) + '/' + value.slice(2);
      }
      e.target.value = value.slice(0, 5);
    });
  }
});
</script>
{% endblock %}