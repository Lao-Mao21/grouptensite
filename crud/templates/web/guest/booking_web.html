{% extends 'base/base_web.html' %}

{% block title %}Book a Room{% endblock title %}

{% block extra_head %}
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css">
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
<style>
  body {
    font-family: 'Inter', -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif;
  }
  .font-heading {
    font-family: 'Inter', -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif;
    font-weight: 600;
  }
  .room-card {
    transition: transform 0.2s ease, box-shadow 0.2s ease;
  }
  .room-card:hover {
    transform: translateY(-2px);
    box-shadow: 0 8px 16px rgba(0,0,0,0.1);
  }
  .room-card button:not(:disabled) {
    cursor: pointer;
  }
  .room-card button:disabled {
    opacity: 0.5;
    cursor: not-allowed;
  }
</style>
{% endblock %}

{% block content %}
<div class="min-h-screen bg-gray-50 py-8">
  <!-- Progress Bar -->
  <div class="max-w-4xl mx-auto mb-8">
    <div class="w-2/3 h-1 bg-gray-200 mx-auto">
      <div class="h-full bg-orange-500 transition-all duration-300" style="width: 33%;"></div>
    </div>
  </div>

  <!-- Step 1: Choose Room -->
  <div id="step1" class="step-content">
    <div class="max-w-4xl mx-auto">
      <h2 class="text-center text-2xl font-heading font-semibold mb-8">Choose your room</h2>
      <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
        {% for room_type in room_types %}
        <div class="room-card bg-white p-4 rounded-lg shadow-md">
          <div class="relative">
            <img src="{{ MEDIA_URL }}{{ room_type.image }}" alt="{{ room_type.name }}" 
                 class="w-full h-48 object-cover rounded-lg mb-3">
            {% if room_type.available == 0 %}
            <div class="absolute inset-0 bg-black bg-opacity-50 rounded-lg flex items-center justify-center">
              <span class="text-white font-medium px-3 py-1 bg-red-500 rounded-full text-sm">
                Currently Unavailable
              </span>
            </div>
            {% endif %}
          </div>
          
          <div class="text-center">
            <div class="bg-{{ room_type.id|lower }} text-white text-sm py-1 px-4 rounded-full inline-block mb-2 font-medium">
              {{ room_type.name|upper }}
            </div>
            <p class="text-gray-700 font-medium mb-2">
              ₱{{ room_type.price|floatformat:2 }} - ₱{{ room_type.max_price|floatformat:2 }}
            </p>
            
            <div class="mb-4">
              {% if room_type.available > 0 %}
              <span class="text-green-600 text-sm font-medium">
                {{ room_type.available }} room{{ room_type.available|pluralize }} available
              </span>
              {% else %}
              <span class="text-red-600 text-sm font-medium">
                No rooms available
              </span>
              {% endif %}
            </div>
            
            <button onclick="selectRoom('{{ room_type.id }}', '{{ room_type.name }}', {{ room_type.price }})" 
                    class="w-full px-4 py-2 bg-orange-500 text-white rounded-lg hover:bg-orange-600 transition-colors font-medium
                           {% if room_type.available == 0 %}opacity-50{% endif %}"
                    {% if room_type.available == 0 %}disabled{% endif %}
                    title="{% if room_type.available == 0 %}This room type is currently unavailable{% else %}Select this room{% endif %}">
              Select Room
            </button>
          </div>
        </div>
        {% endfor %}
      </div>
    </div>
  </div>

  <!-- Step 2: Booking Details -->
  <div id="step2" class="step-content hidden">
    <div class="max-w-2xl mx-auto bg-white rounded-lg shadow-md p-6">
      <h2 class="text-center text-2xl font-heading font-semibold mb-6">Booking VIP Room</h2>
      <form id="bookingForm" class="space-y-4">
        <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
          <!-- Left Column -->
          <div>
            <label class="block text-sm font-medium mb-1">Full Name <span class="text-red-500">*</span></label>
            <input type="text" name="full_name" required class="w-full px-3 py-2 border rounded-lg focus:ring-2 focus:ring-orange-500 focus:border-orange-500 outline-none">
          </div>
          <div>
            <label class="block text-sm font-medium mb-1">Gender <span class="text-red-500">*</span></label>
            <select name="gender" required class="w-full px-3 py-2 border rounded-lg focus:ring-2 focus:ring-orange-500 focus:border-orange-500 outline-none">
              <option value="">Select</option>
              <option value="male">Male</option>
              <option value="female">Female</option>
              <option value="other">Other</option>
            </select>
          </div>
          <div>
            <label class="block text-sm font-medium mb-1">Contact Number <span class="text-red-500">*</span></label>
            <input type="tel" name="contact_number" required class="w-full px-3 py-2 border rounded-lg focus:ring-2 focus:ring-orange-500 focus:border-orange-500 outline-none">
          </div>
          <div>
            <label class="block text-sm font-medium mb-1">Nationality <span class="text-red-500">*</span></label>
            <select name="nationality" required class="w-full px-3 py-2 border rounded-lg focus:ring-2 focus:ring-orange-500 focus:border-orange-500 outline-none">
              <option value="">Select</option>
              <option value="Filipino">Filipino</option>
              <option value="Other">Other</option>
            </select>
          </div>
          <div class="col-span-2">
            <label class="block text-sm font-medium mb-1">Address <span class="text-red-500">*</span></label>
            <input type="text" name="address" required class="w-full px-3 py-2 border rounded-lg focus:ring-2 focus:ring-orange-500 focus:border-orange-500 outline-none">
          </div>
          <div>
            <label class="block text-sm font-medium mb-1">Room Number <span class="text-red-500">*</span></label>
            <select name="room_number" required class="w-full px-3 py-2 border rounded-lg focus:ring-2 focus:ring-orange-500 focus:border-orange-500 outline-none">
              <option value="">Select</option>
              <!-- Add room numbers dynamically -->
            </select>
          </div>
          <div>
            <label class="block text-sm font-medium mb-1">Number of Guests <span class="text-red-500">*</span></label>
            <select name="guest_count" required class="w-full px-3 py-2 border rounded-lg focus:ring-2 focus:ring-orange-500 focus:border-orange-500 outline-none">
              <option value="">Select</option>
              <option value="1">1</option>
              <option value="2">2</option>
              <option value="3">3</option>
              <option value="4">4</option>
            </select>
          </div>
          <div>
            <label class="block text-sm font-medium mb-1">Check IN <span class="text-red-500">*</span></label>
            <input type="datetime-local" name="check_in" required class="w-full px-3 py-2 border rounded-lg focus:ring-2 focus:ring-orange-500 focus:border-orange-500 outline-none">
          </div>
          <div>
            <label class="block text-sm font-medium mb-1">Check OUT <span class="text-red-500">*</span></label>
            <input type="datetime-local" name="check_out" required class="w-full px-3 py-2 border rounded-lg focus:ring-2 focus:ring-orange-500 focus:border-orange-500 outline-none">
          </div>
          <div>
            <label class="block text-sm font-medium mb-1">Expected Arrival <span class="text-red-500">*</span></label>
            <input type="datetime-local" name="expected_arrival" required class="w-full px-3 py-2 border rounded-lg focus:ring-2 focus:ring-orange-500 focus:border-orange-500 outline-none">
          </div>
          <div>
            <label class="block text-sm font-medium mb-1">Mode of Payment <span class="text-red-500">*</span></label>
            <div class="relative">
              <input type="text" value="Credit Card" readonly class="w-full px-3 py-2 border rounded bg-gray-50 focus:ring-2 focus:ring-orange-500 focus:border-orange-500 outline-none">
              <div class="absolute right-2 top-1/2 transform -translate-y-1/2 flex space-x-1">
                <i class="fab fa-cc-visa text-blue-600 text-xl"></i>
                <i class="fab fa-cc-mastercard text-red-500 text-xl"></i>
                <i class="fab fa-cc-amex text-blue-400 text-xl"></i>
              </div>
            </div>
          </div>
        </div>

        <!-- Buttons -->
        <div class="flex justify-between mt-6">
          <button type="button" onclick="prevStep()" class="px-8 py-2 bg-red-500 text-white rounded hover:bg-red-600">
            Back
          </button>
          <button type="button" onclick="validateAndProceed()" class="px-8 py-2 bg-orange-500 text-white rounded hover:bg-orange-600">
            Next
          </button>
        </div>
      </form>
    </div>
  </div>

  <!-- Step 3: Payment -->
  <div id="step3" class="step-content hidden">
    <div class="max-w-md mx-auto bg-white rounded-lg shadow-md p-6">
      <h2 class="text-center text-xl font-medium mb-6">All fields are required</h2>
      <form id="paymentForm" class="space-y-4">
        <div>
          <input type="text" name="card_name" placeholder="Name" required 
                 class="w-full px-3 py-2 border rounded-lg focus:ring-2 focus:ring-orange-500 focus:border-orange-500 outline-none">
        </div>
        <div>
          <input type="text" name="billing_address" placeholder="Billing Address" required 
                 class="w-full px-3 py-2 border rounded-lg focus:ring-2 focus:ring-orange-500 focus:border-orange-500 outline-none">
        </div>
        <div class="relative">
          <input type="text" name="card_number" placeholder="Credit Card number" required 
                 class="w-full pl-3 pr-10 py-2 border rounded-lg focus:ring-2 focus:ring-orange-500 focus:border-orange-500 outline-none"
                 pattern="[0-9]{16}" maxlength="16">
          <div class="absolute right-2 top-1/2 transform -translate-y-1/2">
            <i class="far fa-credit-card text-gray-400"></i>
          </div>
        </div>
        <div class="flex gap-4">
          <div class="relative">
            <input type="text" name="expiry" placeholder="MM/YY" required 
                   class="w-24 pl-3 pr-8 py-2 border rounded-lg focus:ring-2 focus:ring-orange-500 focus:border-orange-500 outline-none"
                   pattern="(0[1-9]|1[0-2])\/([0-9]{2})" maxlength="5">
            <div class="absolute right-2 top-1/2 transform -translate-y-1/2">
              <i class="far fa-calendar text-gray-400"></i>
            </div>
          </div>
          <div class="relative">
            <input type="text" name="cvv" placeholder="Security Code" required 
                   class="w-32 pl-3 pr-8 py-2 border rounded-lg focus:ring-2 focus:ring-orange-500 focus:border-orange-500 outline-none"
                   pattern="[0-9]{3,4}" maxlength="4">
            <div class="absolute right-2 top-1/2 transform -translate-y-1/2">
              <i class="fas fa-lock text-gray-400"></i>
            </div>
          </div>
          <div class="text-right flex-1">
            <div class="font-medium">Total Amount</div>
            <div class="text-xl">₱ <span id="finalAmount">0.00</span></div>
          </div>
        </div>

        <div class="flex justify-between mt-6">
          <button type="button" onclick="prevStep()" class="px-8 py-2 bg-red-500 text-white rounded hover:bg-red-600">
            Cancel
          </button>
          <button type="button" onclick="processPayment()" class="px-8 py-2 bg-green-500 text-white rounded hover:bg-green-600">
            Pay now
          </button>
        </div>
      </form>
    </div>
  </div>

  <!-- Step 4: Success -->
  <div id="step4" class="step-content hidden">
    <div class="max-w-md mx-auto bg-white rounded-lg shadow-md p-8 text-center">
      <div class="w-16 h-16 bg-green-100 rounded-full flex items-center justify-center mx-auto mb-4">
        <svg class="w-8 h-8 text-green-500" fill="none" stroke="currentColor" viewBox="0 0 24 24">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"></path>
        </svg>
      </div>
      <h2 class="text-2xl font-bold text-green-500 mb-2">Congratulations!</h2>
      <p class="text-gray-600 mb-6">You've Successfully Booked a Room</p>
      <a href="{% url 'landing_page' %}" class="inline-block px-8 py-2 bg-green-500 text-white rounded-full hover:bg-green-600">
        Home
      </a>
    </div>
  </div>
</div>
{% endblock %}

{% block scripts %}
<script>
let currentStep = 1;
const totalSteps = 4;
let selectedRoom = null;
let roomPrice = 0;

function updateProgress() {
  const progressBar = document.querySelector('.bg-orange-500');
  const progress = ((currentStep) / totalSteps) * 100;
  progressBar.style.width = `${progress}%`;
}

function showStep(step) {
  document.querySelectorAll('.step-content').forEach(content => {
    content.classList.add('hidden');
  });
  document.getElementById(`step${step}`).classList.remove('hidden');
  currentStep = step;
  updateProgress();
}

function selectRoom(roomId, roomName, price) {
  console.log('Selecting room:', roomId, roomName, price); // Debug log
  selectedRoom = roomId;
  roomPrice = parseFloat(price);
  
  // Update room numbers dropdown
  const roomNumberSelect = document.querySelector('select[name="room_number"]');
  if (roomNumberSelect) {
    // Clear existing options
    roomNumberSelect.innerHTML = '<option value="">Select</option>';
    
    // Add available room numbers (you'll need to modify this based on your data)
    // This is a placeholder - you should populate this with actual available room numbers
    for (let i = 1; i <= 5; i++) {
      const option = document.createElement('option');
      option.value = `${roomId}-${i}`;
      option.textContent = `Room ${i}`;
      roomNumberSelect.appendChild(option);
    }
  }
  
  // Update booking title
  const bookingTitle = document.querySelector('#step2 h2');
  if (bookingTitle) {
    bookingTitle.textContent = `Booking ${roomName} Room`;
  }
  
  // Calculate initial total
  calculateTotal();
  
  // Proceed to next step
  nextStep();
}

function nextStep() {
  if (currentStep < totalSteps) {
    currentStep++;
    showStep(currentStep);
  }
}

function prevStep() {
  if (currentStep > 1) {
    currentStep--;
    showStep(currentStep);
  }
}

function validateAndProceed() {
  const form = document.getElementById('bookingForm');
  if (form.checkValidity()) {
    calculateTotal(); // Recalculate total before proceeding
    nextStep();
  } else {
    form.reportValidity();
  }
}

function validatePaymentForm() {
  const form = document.getElementById('paymentForm');
  
  // Card number validation
  const cardNumber = form.card_number.value;
  if (!/^[0-9]{16}$/.test(cardNumber)) {
    alert('Please enter a valid 16-digit card number');
    return false;
  }
  
  // Expiry date validation
  const expiry = form.expiry.value;
  if (!/^(0[1-9]|1[0-2])\/([0-9]{2})$/.test(expiry)) {
    alert('Please enter a valid expiry date (MM/YY)');
    return false;
  }
  
  // CVV validation
  const cvv = form.cvv.value;
  if (!/^[0-9]{3,4}$/.test(cvv)) {
    alert('Please enter a valid security code (3-4 digits)');
    return false;
  }
  
  return true;
}

function processPayment() {
  if (validatePaymentForm()) {
    // Simulate payment processing
    const loadingBtn = document.querySelector('#paymentForm button[type="button"]:last-child');
    loadingBtn.disabled = true;
    loadingBtn.innerHTML = '<span class="inline-block animate-spin mr-2">↻</span> Processing...';
    
    // Simulate API call delay
    setTimeout(() => {
      nextStep();
    }, 2000);
  }
}

function calculateTotal() {
  const checkInInput = document.querySelector('input[name="check_in"]');
  const checkOutInput = document.querySelector('input[name="check_out"]');
  
  if (checkInInput && checkOutInput && checkInInput.value && checkOutInput.value && roomPrice) {
    const checkIn = new Date(checkInInput.value);
    const checkOut = new Date(checkOutInput.value);
    const days = Math.ceil((checkOut - checkIn) / (1000 * 60 * 60 * 24));
    if (days > 0) {
      const total = days * roomPrice;
      const finalAmountElement = document.getElementById('finalAmount');
      if (finalAmountElement) {
        finalAmountElement.textContent = total.toFixed(2);
      }
    }
  }
}

document.addEventListener('DOMContentLoaded', function() {
  updateProgress();
  
  // Format expiry date input
  const expiryInput = document.querySelector('input[name="expiry"]');
  if (expiryInput) {
    expiryInput.addEventListener('input', function(e) {
      let value = e.target.value.replace(/\D/g, '');
      if (value.length >= 2) {
        value = value.slice(0, 2) + '/' + value.slice(2);
      }
      e.target.value = value.slice(0, 5);
    });
  }
  
  // Add event listeners for total calculation
  const checkInInput = document.querySelector('input[name="check_in"]');
  const checkOutInput = document.querySelector('input[name="check_out"]');
  
  if (checkInInput && checkOutInput) {
    checkInInput.addEventListener('change', calculateTotal);
    checkOutInput.addEventListener('change', calculateTotal);
  }
});
</script>
{% endblock %}
