{% extends 'base/base_web.html' %}
{% load static %}

{% block title %}Book a Room{% endblock title %}

{% block extra_head %}
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css">
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/flatpickr/dist/flatpickr.min.css">
<script src="https://cdn.jsdelivr.net/npm/flatpickr"></script>
<script src="https://js.stripe.com/v3/"></script>
<style>
  body {
    font-family: 'Inter', -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif;
  }
  .font-heading {
    font-family: 'Inter', -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif;
    font-weight: 600;
  }
  .room-card {
    transition: transform 0.2s ease, box-shadow 0.2s ease;
  }   
  .room-card:hover {
    transform: translateY(-2px);
    box-shadow: 0 8px 16px rgba(0,0,0,0.1);
  }
  .room-card button:not(:disabled) {
    cursor: pointer;
  }
  .room-card button:disabled {
    opacity: 0.5;
    cursor: not-allowed;
  }
  .back-button {
    transition: transform 0.2s ease;
  }
  .back-button:hover {
    transform: translateX(-2px);
  }
  
  /* Login Modal Styles */
  .modal {
    display: none;
    position: fixed;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    background-color: rgba(0, 0, 0, 0.5);
    z-index: 1000;
  }
  
  .modal.show {
    display: flex;
    align-items: center;
    justify-content: center;
  }
  
  .modal-content {
    animation: slideIn 0.3s ease-out;
  }
  
  @keyframes slideIn {
    from {
      transform: translateY(-20px);
      opacity: 0;
    }
    to {
      transform: translateY(0);
      opacity: 1;
    }
  }

  /* Stripe Elements styling */
  .StripeElement {
    box-sizing: border-box;
    height: 40px;
    padding: 10px 12px;
    border: 1px solid #e2e8f0;
    border-radius: 0.5rem;
    background-color: white;
    transition: box-shadow 150ms ease;
  }

  .StripeElement--focus {
    box-shadow: 0 0 0 2px #f97316;
    border-color: #f97316;
  }

  .StripeElement--invalid {
    border-color: #ef4444;
  }

  .StripeElement--webkit-autofill {
    background-color: #fefde5 !important;
  }
</style>
{% endblock %}

{% block content %}
<div class="min-h-screen bg-gray-50 py-8">
  <!-- Back Button -->
  <div class="max-w-4xl mx-auto mb-6">
    <a href="{% url 'nova_hotel' %}" class="back-button inline-flex items-center text-gray-600 hover:text-gray-900">
      <svg class="w-5 h-5 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10 19l-7-7m0 0l7-7m-7 7h18"/>
      </svg>
      Back to Home
    </a>
  </div>

  <!-- Progress Bar -->
  <div class="max-w-4xl mx-auto mb-8">
    <div class="w-2/3 h-1 bg-gray-200 mx-auto">
      <div class="h-full bg-orange-500 transition-all duration-300" style="width: 33%;"></div>
    </div>
  </div>

  <!-- Step 1: Choose Room -->
  <div id="step1" class="step-content">
    <div class="max-w-6xl mx-auto">
      <h2 class="text-center text-2xl font-heading font-semibold mb-8">Choose your room</h2>

      <!-- Room Type Filter -->
      <div class="mb-6 flex flex-wrap gap-3 justify-center">
        <button type="button" class="room-type-filter active px-4 py-2 rounded-full text-sm font-medium bg-orange-500 text-white hover:bg-orange-600 transition-colors" data-type="all">
          All Rooms
        </button>
        {% for room_type in room_types %}
        <button type="button" class="room-type-filter px-4 py-2 rounded-full text-sm font-medium bg-gray-200 text-gray-700 hover:bg-gray-300 transition-colors" data-type="{{ room_type.id }}">
          {{ room_type.name }}
        </button>
        {% endfor %}
      </div>

      <!-- Search and Sort -->
      <div class="mb-6 flex flex-wrap gap-4 items-center justify-between">
        <div class="flex-1 max-w-xs">
          <input type="text" id="room-search" placeholder="Search rooms..." class="w-full px-4 py-2 rounded-lg border border-gray-300 focus:ring-2 focus:ring-orange-500 focus:border-orange-500">
        </div>
        <div class="flex gap-3">
          <select id="room-sort" class="px-4 py-2 rounded-lg border border-gray-300 focus:ring-2 focus:ring-orange-500 focus:border-orange-500">
            <option value="price-asc">Price: Low to High</option>
            <option value="price-desc">Price: High to Low</option>
            <option value="type">Room Type</option>
            <option value="number">Room Number</option>
          </select>
        </div>
      </div>

      <!-- Room Grid -->
      <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6" id="room-grid">
        {% for room in available_rooms %}
        <div class="room-card bg-white rounded-lg shadow-md overflow-hidden" data-room-type="{{ room.room_type|lower }}" data-room-price="{{ room.room_price }}">
          <div class="relative">
            <img src="{{ MEDIA_URL }}{{ room.room_type|lower }}.jpg" 
                 alt="{{ room.get_room_type_display }}" 
                 class="w-full h-48 object-cover">
            {% if room.room_status != 'available' %}
            <div class="absolute inset-0 bg-black bg-opacity-50 flex items-center justify-center">
              <span class="text-white font-medium px-3 py-1 bg-red-500 rounded-full text-sm">
                Currently Unavailable
              </span>
            </div>
            {% endif %}
            <div class="absolute top-3 right-3">
              <span class="bg-orange-500 text-white text-sm py-1 px-3 rounded-full font-medium">
                Room {{ room.room_number }}
              </span>
            </div>
          </div>
          
          <div class="p-4">
            <div class="flex items-center justify-between mb-2">
              <h3 class="text-lg font-semibold text-gray-900">{{ room.get_room_type_display }}</h3>
              <p class="text-orange-500 font-bold">â‚±{{ room.room_price|floatformat:2 }}</p>
            </div>
            
            <div class="space-y-2">
              <div class="flex items-center text-sm text-gray-600">
                <svg class="w-4 h-4 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 21V5a2 2 0 00-2-2H7a2 2 0 00-2 2v16m14 0h2m-2 0h-5m-9 0H3m2 0h5M9 7h1m-1 4h1m4-4h1m-1 4h1m-5 10v-5a1 1 0 011-1h2a1 1 0 011 1v5m-4 0h4"/>
                </svg>
                Room {{ room.room_number }}
              </div>
              <div class="flex items-center text-sm text-gray-600">
                <svg class="w-4 h-4 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 3v4M3 5h4M6 17v4m-2-2h4m5-16l2.286 6.857L21 12l-5.714 2.143L13 21l-2.286-6.857L5 12l5.714-2.143L13 3z"/>
                </svg>
                {{ room.get_room_type_display }}
              </div>
              {% if room.room_status == 'available' %}
              <div class="flex items-center text-sm text-green-600">
                <svg class="w-4 h-4 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z"/>
                </svg>
                Available Now
              </div>
              {% endif %}
            </div>
            
            <button type="button"
                    data-room-id="{{ room.room_id }}"
                    data-room-type="{{ room.room_type }}"
                    data-room-number="{{ room.room_number }}"
                    data-room-name="{{ room.get_room_type_display }}"
                    data-room-price="{{ room.room_price }}"
                    class="select-room-btn mt-4 w-full px-4 py-2 {% if room.room_status == 'available' %}bg-orange-500 hover:bg-orange-600{% else %}bg-gray-300{% endif %} text-white rounded-lg transition-colors font-medium"
                    {% if room.room_status != 'available' %}disabled{% endif %}>
              {% if room.room_status == 'available' %}
                Select Room
              {% else %}
                Not Available
              {% endif %}
            </button>
          </div>
        </div>
        {% empty %}
        <div class="col-span-full text-center py-8">
          <div class="text-gray-500 text-lg">No rooms are currently available.</div>
          <p class="text-gray-400 mt-2">Please check back later or contact us for assistance.</p>
        </div>
        {% endfor %}
      </div>

      <!-- Pagination -->
      <div class="mt-8 flex justify-center items-center space-x-2" id="pagination">
        <button class="pagination-btn" data-page="prev" disabled>
          <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 19l-7-7 7-7"/>
          </svg>
        </button>
        <div id="page-numbers" class="flex space-x-2"></div>
        <button class="pagination-btn" data-page="next">
          <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7"/>
          </svg>
        </button>
      </div>
    </div>
  </div>

  <!-- Step 2: Booking Details -->
  <div id="step2" class="step-content hidden">
    <div class="max-w-2xl mx-auto bg-white rounded-lg shadow-md p-6">
      <h2 class="text-center text-2xl font-heading font-semibold mb-6">Booking Details</h2>
      <form id="bookingForm" class="space-y-4">
        {% csrf_token %}
        <!-- Hidden fields for room data -->
        <input type="hidden" id="selected_room_id" name="room_id">
        <input type="hidden" id="selected_room_price" name="room_price">
        
        <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
          <!-- Left Column -->
          <div>
            <label class="block text-sm font-medium mb-1">Full Name <span class="text-red-500">*</span></label>
            <input type="text" name="full_name" required 
                   class="w-full px-3 py-2 border rounded-lg focus:ring-2 focus:ring-orange-500 focus:border-orange-500 outline-none bg-gray-50"
                   value="{{ guest_account.full_name }}" readonly>
          </div>
          <div>
            <label class="block text-sm font-medium mb-1">Gender <span class="text-red-500">*</span></label>
            <input type="text" name="gender" required 
                   class="w-full px-3 py-2 border rounded-lg focus:ring-2 focus:ring-orange-500 focus:border-orange-500 outline-none bg-gray-50"
                   value="{{ guest_account.gender }}" readonly>
          </div>
          <div>
            <label class="block text-sm font-medium mb-1">Contact Number <span class="text-red-500">*</span></label>
            <input type="tel" name="contact_number" required 
                   class="w-full px-3 py-2 border rounded-lg focus:ring-2 focus:ring-orange-500 focus:border-orange-500 outline-none bg-gray-50"
                   value="{{ guest_account.phone_number }}" readonly>
          </div>
          <div>
            <label class="block text-sm font-medium mb-1">Nationality <span class="text-red-500">*</span></label>
            <input type="text" name="nationality" required 
                   class="w-full px-3 py-2 border rounded-lg focus:ring-2 focus:ring-orange-500 focus:border-orange-500 outline-none bg-gray-50"
                   value="{{ guest_account.nationality }}" readonly>
          </div>
          <div class="col-span-2">
            <label class="block text-sm font-medium mb-1">Address <span class="text-red-500">*</span></label>
            <input type="text" name="address" required 
                   class="w-full px-3 py-2 border rounded-lg focus:ring-2 focus:ring-orange-500 focus:border-orange-500 outline-none bg-gray-50"
                   value="{{ guest_account.address }}" readonly>
          </div>
          <div>
            <label class="block text-sm font-medium mb-1">Room Number & Type <span class="text-red-500">*</span></label>
            <select name="room_number" id="room-select" required class="w-full px-3 py-2 border rounded-lg focus:ring-2 focus:ring-orange-500 focus:border-orange-500 outline-none">
              <option value="">Select Available Room</option>
              {% for room in available_rooms %}
                <option value="{{ room.room_id }}" 
                        data-room-type="{{ room.room_type }}"
                        data-price="{{ room.room_price }}"
                        data-price-type="per day/night">
                  Room {{ room.room_number }} - {{ room.get_room_type_display }} (â‚±{{ room.room_price|floatformat:2 }})
                </option>
              {% endfor %}
            </select>
          </div>
          <div>
            <label class="block text-sm font-medium mb-1">Number of Guests <span class="text-red-500">*</span></label>
            <select name="guest_count" required class="w-full px-3 py-2 border rounded-lg focus:ring-2 focus:ring-orange-500 focus:border-orange-500 outline-none">
              <option value="">Select</option>
              <option value="1">1</option>
              <option value="2">2</option>
              <option value="3">3</option>
              <option value="4">4</option>
            </select>
          </div>
          <div>
            <label class="block text-sm font-medium mb-1">Check IN <span class="text-red-500">*</span></label>
            <input type="text" name="check_in" required 
                   class="datepicker w-full px-3 py-2 border rounded-lg focus:ring-2 focus:ring-orange-500 focus:border-orange-500 outline-none"
                   placeholder="Select date and time">
          </div>
          <div>
            <label class="block text-sm font-medium mb-1">Check OUT <span class="text-red-500">*</span></label>
            <input type="text" name="check_out" required 
                   class="datepicker w-full px-3 py-2 border rounded-lg focus:ring-2 focus:ring-orange-500 focus:border-orange-500 outline-none"
                   placeholder="Select date and time">
          </div>
          <div>
            <label class="block text-sm font-medium mb-1">Expected Arrival <span class="text-red-500">*</span></label>
            <input type="text" name="expected_arrival" required 
                   class="datepicker w-full px-3 py-2 border rounded-lg focus:ring-2 focus:ring-orange-500 focus:border-orange-500 outline-none"
                   placeholder="Select date and time">
          </div>
        </div>

        <!-- Buttons -->
        <div class="flex justify-between mt-6">
          <button type="button" onclick="prevStep()" class="px-8 py-2 bg-red-500 text-white rounded-lg hover:bg-red-600">
            Back
          </button>
          <button type="button" onclick="validateAndProceed()" class="px-8 py-2 bg-orange-500 text-white rounded-lg hover:bg-orange-600">
            Next
          </button>
        </div>
      </form>
    </div>
  </div>

  <!-- Step 3: Payment -->
  <div id="step3" class="step-content hidden">
    <div class="max-w-md mx-auto bg-white rounded-lg shadow-md p-6">
      <h2 class="text-center text-2xl font-medium mb-6">Payment Information</h2>
      <form id="paymentForm" class="space-y-4">
        {% csrf_token %}
        
        <!-- Mode of Payment -->
        <div>
          <label class="block text-sm font-medium mb-1">Mode of Payment <span class="text-red-500">*</span></label>
          <select id="paymentMode" name="payment_mode" required class="w-full px-3 py-2 border rounded-lg focus:ring-2 focus:ring-orange-500 focus:border-orange-500 outline-none">
            <option value="credit_card">Credit Card</option>
          </select>
        </div>

        <!-- Card holder name -->
        <div>
          <label class="block text-sm font-medium mb-1">Card Holder Name <span class="text-red-500">*</span></label>
          <input type="text" id="cardName" name="card_name" placeholder="Name on card"
                 class="w-full px-3 py-2 border rounded-lg focus:ring-2 focus:ring-orange-500 focus:border-orange-500 outline-none" required>
        </div>

        <!-- Billing address -->
        <div>
          <label class="block text-sm font-medium mb-1">Billing Address <span class="text-red-500">*</span></label>
          <input type="text" id="billingAddress" name="billing_address" placeholder="One, Two, Three"
                 class="w-full px-3 py-2 border rounded-lg focus:ring-2 focus:ring-orange-500 focus:border-orange-500 outline-none"
                 value="{{ guest_account.address }}" required>
        </div>

        <!-- Card Number -->
        <div>
          <label class="block text-sm font-medium mb-1">Card Number <span class="text-red-500">*</span></label>
          <div class="relative">
            <input type="text" id="card-number" name="card_number" required
                   class="w-full px-3 py-2 border rounded-lg focus:ring-2 focus:ring-orange-500 focus:border-orange-500 outline-none"
                   placeholder="1234 5678 9012 3456">
            <div class="absolute right-3 top-1/2 transform -translate-y-1/2 flex space-x-2">
              <i class="fa-brands fa-cc-visa text-gray-400 text-xl"></i>
              <i class="fa-brands fa-cc-mastercard text-gray-400 text-xl"></i>
              <i class="fa-brands fa-cc-amex text-gray-400 text-xl"></i>
            </div>
          </div>
        </div>

        <div class="grid grid-cols-2 gap-4">
          <!-- Expiry Date -->
          <div>
            <label class="block text-sm font-medium mb-1">Expiry Date <span class="text-red-500">*</span></label>
            <input type="text" id="card-expiry" name="card_expiry" required
                   class="w-full px-3 py-2 border rounded-lg focus:ring-2 focus:ring-orange-500 focus:border-orange-500 outline-none"
                   placeholder="MM/YY">
          </div>

          <!-- CVV -->
          <div>
            <label class="block text-sm font-medium mb-1">CVV <span class="text-red-500">*</span></label>
            <input type="text" id="card-cvv" name="card_cvv" required
                   class="w-full px-3 py-2 border rounded-lg focus:ring-2 focus:ring-orange-500 focus:border-orange-500 outline-none"
                   placeholder="123" maxlength="4">
          </div>
        </div>

        <div id="card-errors" class="mt-2 text-sm text-red-600" role="alert"></div>

        <!-- Total Amount -->
        <div class="text-right border-t pt-4 mt-4">
          <div class="font-medium">Total Amount</div>
          <div class="text-xl">â‚± <span id="finalAmount">0.00</span></div>
        </div>

        <!-- Action Buttons -->
        <div class="flex justify-between mt-6">
          <button type="button" onclick="prevStep()" class="px-8 py-2 bg-red-500 text-white rounded-lg hover:bg-red-600">
            Back
          </button>
          <button type="submit" id="submit-button" class="px-8 py-2 bg-green-500 text-white rounded-lg hover:bg-green-600">
            Pay now
          </button>
        </div>
      </form>
    </div>
  </div>

  <!-- Step 4: Success -->
  <div id="step4" class="step-content hidden">
    <div class="max-w-md mx-auto bg-white rounded-lg shadow-md p-8 text-center">
      <div class="w-16 h-16 bg-green-100 rounded-full flex items-center justify-center mx-auto mb-4">
        <svg class="w-8 h-8 text-green-500" fill="none" stroke="currentColor" viewBox="0 0 24 24">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"></path>
        </svg>
      </div>
      <h2 class="text-2xl font-bold text-green-500 mb-2">Congratulations!</h2>
      <p class="text-gray-600 mb-6">Your Room Reservation is Confirmed</p>
      <p class="text-sm text-gray-500 mb-6">Please check your email for the reservation details and check-in instructions.</p>
      <a href="{% url 'nova_hotel' %}" class="inline-block px-8 py-2 bg-green-500 text-white rounded-full hover:bg-green-600">
        Home
      </a>
    </div>
  </div>
</div>
{% endblock %}

{% block scripts %}
<script>
let currentStep = 1;
const totalSteps = 4;
let selectedRoom = null;
let roomPrice = 0;

// Function to check room availability
async function checkRoomAvailability(roomData, checkIn = null, checkOut = null) {
  try {
    // Construct URL with proper encoding
    let url = `/check-room-availability/${roomData.type}/${roomData.number}/`;
    if (checkIn && checkOut) {
      const params = new URLSearchParams({
        check_in: checkIn,
        check_out: checkOut
      });
      url += `?${params.toString()}`;
    }
    
    const response = await fetch(url);
    if (!response.ok) {
      throw new Error(`HTTP error! status: ${response.status}`);
    }
    
    const data = await response.json();
    
    if (!data.success) {
      throw new Error(data.message || 'Room is not available');
    }
    
    return data.room_status === 'available';
  } catch (error) {
    console.error('Error checking room availability:', error);
    alert(error.message || 'Error checking room availability. Please try again.');
    return false;
  }
}

function updateProgress() {
  const progressBar = document.querySelector('.bg-orange-500');
  const progress = ((currentStep) / totalSteps) * 100;
  progressBar.style.width = `${progress}%`;
}

function showStep(step) {
  document.querySelectorAll('.step-content').forEach(content => {
    content.classList.add('hidden');
  });
  document.getElementById(`step${step}`).classList.remove('hidden');
  currentStep = step;
  updateProgress();
}

async function selectRoom(roomData) {
  try {
    // Show loading state
    const button = document.querySelector(`[data-room-id="${roomData.id}"]`);
    const originalText = button.innerHTML;
    button.disabled = true;
    button.innerHTML = '<span class="inline-block animate-spin mr-2">â†»</span> Checking...';
    
    // Check availability before proceeding
    const isAvailable = await checkRoomAvailability({
      type: roomData.type,
      number: roomData.number
    });
    
    if (!isAvailable) {
      button.innerHTML = 'Not Available';
      setTimeout(() => {
        button.innerHTML = originalText;
        button.disabled = false;
      }, 2000);
      return;
    }
    
    selectedRoom = roomData;
    roomPrice = parseFloat(roomData.price);
    
    // Update room select dropdown
    const roomSelect = document.getElementById('room-select');
    if (roomSelect) {
      roomSelect.value = roomData.id;
      const selectedOption = roomSelect.options[roomSelect.selectedIndex];
      if (selectedOption) {
        roomPrice = parseFloat(selectedOption.dataset.price);
      }
    }
    
    // Update hidden fields
    document.getElementById('selected_room_id').value = roomData.id;
    document.getElementById('selected_room_price').value = roomPrice;
    
    calculateTotal();
    nextStep();
    
    // Reset button state
    button.innerHTML = originalText;
    button.disabled = false;
  } catch (error) {
    console.error('Error selecting room:', error);
    alert('Error selecting room. Please try again.');
    
    // Reset button state
    const button = document.querySelector(`[data-room-id="${roomData.id}"]`);
    if (button) {
      button.innerHTML = 'Select Room';
      button.disabled = false;
    }
  }
}

function calculateTotal() {
  try {
    const checkInInput = document.querySelector('input[name="check_in"]');
    const checkOutInput = document.querySelector('input[name="check_out"]');
    
    if (checkInInput && checkOutInput && selectedRoom) {
      const checkIn = new Date(checkInInput.value);
      const checkOut = new Date(checkOutInput.value);
      
      if (!isNaN(checkIn) && !isNaN(checkOut) && roomPrice) {
        const days = Math.ceil((checkOut - checkIn) / (1000 * 60 * 60 * 24));
        if (days <= 0) {
          document.getElementById('finalAmount').textContent = '0.00';
          return;
        }
        const total = days * roomPrice;
        document.getElementById('finalAmount').textContent = total.toFixed(2);
      }
    }
  } catch (error) {
    console.error('Error calculating total:', error);
  }
}

function nextStep() {
  if (currentStep < totalSteps) {
    currentStep++;
    showStep(currentStep);
  }
}

function prevStep() {
  if (currentStep > 1) {
    currentStep--;
    showStep(currentStep);
  }
}

async function validateAndProceed() {
  try {
    const form = document.getElementById('bookingForm');
    
    // Check if a room is selected
    if (!selectedRoom) {
      alert('Please select a room first');
      return;
    }
    
    // Get form data
    const checkIn = form.querySelector('[name="check_in"]').value;
    const checkOut = form.querySelector('[name="check_out"]').value;
    const guestCount = form.querySelector('[name="guest_count"]').value;
    const expectedArrival = form.querySelector('[name="expected_arrival"]').value;
    
    // Validate required fields
    if (!checkIn || !checkOut || !guestCount || !expectedArrival) {
      alert('Please fill in all required fields');
      return;
    }
    
    // Show loading state
    const nextButton = form.querySelector('button[onclick="validateAndProceed()"]');
    const originalText = nextButton.innerHTML;
    nextButton.disabled = true;
    nextButton.innerHTML = '<span class="inline-block animate-spin mr-2">â†»</span> Checking...';
    
    try {
      // Check room availability for selected dates
      const isAvailable = await checkRoomAvailability({
        type: selectedRoom.type,
        number: selectedRoom.number
      }, checkIn, checkOut);
      
      if (!isAvailable) {
        alert('Room is no longer available for the selected dates');
        nextButton.innerHTML = originalText;
        nextButton.disabled = false;
        return;
      }
      
      // Store booking details
      const bookingDetails = {
        room_id: selectedRoom.id,
        room_type: selectedRoom.type,
        room_number: selectedRoom.number,
        room_price: roomPrice,
        check_in: checkIn,
        check_out: checkOut,
        guest_count: guestCount,
        expected_arrival: expectedArrival,
        total_amount: document.getElementById('finalAmount').textContent
      };
      sessionStorage.setItem('bookingDetails', JSON.stringify(bookingDetails));
      
      nextStep();
    } finally {
      // Reset button state
      nextButton.innerHTML = originalText;
      nextButton.disabled = false;
    }
  } catch (error) {
    console.error('Error validating form:', error);
    alert('Error validating form. Please try again.');
  }
}

// Initialize on page load
document.addEventListener('DOMContentLoaded', function() {
  updateProgress();

  // Add click handlers for room selection buttons
  document.querySelectorAll('.select-room-btn').forEach(button => {
    button.addEventListener('click', function() {
      if (!this.disabled) {
        const roomData = {
          id: this.dataset.roomId,
          type: this.dataset.roomType,
          number: this.dataset.roomNumber,
          name: this.dataset.roomName,
          price: parseFloat(this.dataset.roomPrice)
        };
        selectRoom(roomData);
      }
    });
  });

  // Initialize Flatpickr with improved date validation
  const today = new Date();
  const tomorrow = new Date(today);
  tomorrow.setDate(tomorrow.getDate() + 1);

  // Common configuration
  const commonConfig = {
    enableTime: true,
    dateFormat: "Y-m-d H:i",
    time_24hr: false,
    minuteIncrement: 30,
    disableMobile: true,
    allowInput: true
  };

  // Expected arrival picker with improved validation
  const expectedArrivalPicker = flatpickr('input[name="expected_arrival"]', {
    ...commonConfig,
    minDate: "today",
    onChange: function(selectedDates) {
      const selectedDate = selectedDates[0];
      if (selectedDate) {
        // Get check-out date only
        const checkOutDate = checkOutPicker.selectedDates[0];
        
        // Only validate against check-out date
        if (checkOutDate && selectedDate >= checkOutDate) {
          const maxExpectedArrival = new Date(checkOutDate);
          maxExpectedArrival.setMinutes(maxExpectedArrival.getMinutes() - 1);
          this.setDate(maxExpectedArrival);
          alert("Expected arrival must be before check-out time");
          return;
        }
      }
    }
  });

  // Check-in picker with improved validation
  const checkInPicker = flatpickr('input[name="check_in"]', {
    ...commonConfig,
    minDate: "today",
    onChange: function(selectedDates) {
      const selectedDate = selectedDates[0];
      if (selectedDate) {
        // Set minimum check-out date to 1 hour after check-in
        const minCheckOut = new Date(selectedDate);
        minCheckOut.setHours(minCheckOut.getHours() + 1);
        checkOutPicker.set('minDate', minCheckOut);

        // If check-out is before new check-in, update it
        const checkOutDate = checkOutPicker.selectedDates[0];
        if (checkOutDate && checkOutDate <= selectedDate) {
          checkOutPicker.setDate(minCheckOut);
        }

        calculateTotal();
        validateDateOverlap();
      }
    }
  });

  // Check-out picker with improved validation
  const checkOutPicker = flatpickr('input[name="check_out"]', {
    ...commonConfig,
    minDate: tomorrow,
    onChange: function(selectedDates) {
      const selectedDate = selectedDates[0];
      if (selectedDate) {
        // Check if check-out is after check-in
        const checkInDate = checkInPicker.selectedDates[0];
        if (checkInDate && selectedDate <= checkInDate) {
          const minCheckOut = new Date(checkInDate);
          minCheckOut.setHours(minCheckOut.getHours() + 1);
          this.setDate(minCheckOut);
          alert("Check-out must be at least 1 hour after check-in");
        }
        calculateTotal();
        validateDateOverlap();
      }
    }
  });

  // Room select change handler with availability check
  const roomSelect = document.getElementById('room-select');
  if (roomSelect) {
    roomSelect.addEventListener('change', async function() {
      const selectedOption = this.options[this.selectedIndex];
      if (selectedOption.value) {
        roomPrice = parseFloat(selectedOption.dataset.price);
        calculateTotal();
        await validateDateOverlap();
      }
    });
  }

  // Initialize payment form handlers
  initializePaymentForm();

  // Room filtering and pagination variables
  let currentPage = 1;
  const roomsPerPage = 6;
  let filteredRooms = [];
  let currentFilter = 'all';
  let currentSort = 'price-asc';
  let searchTerm = '';

  // Get all room cards and store initial state
  const roomGrid = document.getElementById('room-grid');
  const allRooms = Array.from(document.querySelectorAll('.room-card'));
  filteredRooms = allRooms;

  // Initialize room type filters
  document.querySelectorAll('.room-type-filter').forEach(button => {
    button.addEventListener('click', function() {
      // Update active state
      document.querySelectorAll('.room-type-filter').forEach(btn => {
        btn.classList.remove('active', 'bg-orange-500', 'text-white');
        btn.classList.add('bg-gray-200', 'text-gray-700');
      });
      this.classList.add('active', 'bg-orange-500', 'text-white');
      this.classList.remove('bg-gray-200', 'text-gray-700');

      // Apply filter
      currentFilter = this.dataset.type;
      currentPage = 1;
      filterAndDisplayRooms();
    });
  });

  // Initialize search with debounce
  const searchInput = document.getElementById('room-search');
  let searchTimeout;
  searchInput.addEventListener('input', function() {
    clearTimeout(searchTimeout);
    searchTimeout = setTimeout(() => {
      searchTerm = this.value.toLowerCase();
      currentPage = 1;
      filterAndDisplayRooms();
    }, 300); // Debounce for 300ms
  });

  // Initialize sort
  const sortSelect = document.getElementById('room-sort');
  sortSelect.addEventListener('change', function() {
    currentSort = this.value;
    filterAndDisplayRooms();
  });

  // Filter and sort rooms
  function filterAndDisplayRooms() {
    // Filter rooms
    filteredRooms = allRooms.filter(room => {
      if (!room.dataset.roomType) return false;
      
      const matchesType = currentFilter === 'all' || room.dataset.roomType === currentFilter;
      const matchesSearch = room.textContent.toLowerCase().includes(searchTerm);
      return matchesType && matchesSearch;
    });

    // Sort rooms
    filteredRooms.sort((a, b) => {
      const priceA = parseFloat(a.dataset.roomPrice);
      const priceB = parseFloat(b.dataset.roomPrice);
      const roomNumberA = a.querySelector('.room-number')?.textContent.match(/\d+/)?.[0] || '0';
      const roomNumberB = b.querySelector('.room-number')?.textContent.match(/\d+/)?.[0] || '0';
      
      switch(currentSort) {
        case 'price-asc':
          return priceA - priceB;
        case 'price-desc':
          return priceB - priceA;
        case 'type':
          return a.dataset.roomType.localeCompare(b.dataset.roomType);
        case 'number':
          return parseInt(roomNumberA) - parseInt(roomNumberB);
        default:
          return 0;
      }
    });

    updatePagination();
    displayRooms();
    updateNoResultsMessage();
  }

  // Update pagination controls
  function updatePagination() {
    const totalPages = Math.max(1, Math.ceil(filteredRooms.length / roomsPerPage));
    const pageNumbers = document.getElementById('page-numbers');
    pageNumbers.innerHTML = '';

    // Previous button
    const prevButton = document.querySelector('.pagination-btn[data-page="prev"]');
    prevButton.disabled = currentPage === 1;
    prevButton.classList.toggle('opacity-50', currentPage === 1);

    // Calculate visible page range
    let startPage = Math.max(1, currentPage - 2);
    let endPage = Math.min(totalPages, startPage + 4);
    startPage = Math.max(1, endPage - 4);

    // Add first page if not in range
    if (startPage > 1) {
      addPageButton(1);
      if (startPage > 2) pageNumbers.appendChild(createEllipsis());
    }

    // Add page numbers
    for (let i = startPage; i <= endPage; i++) {
      addPageButton(i);
    }

    // Add last page if not in range
    if (endPage < totalPages) {
      if (endPage < totalPages - 1) pageNumbers.appendChild(createEllipsis());
      addPageButton(totalPages);
    }

    // Next button
    const nextButton = document.querySelector('.pagination-btn[data-page="next"]');
    nextButton.disabled = currentPage === totalPages;
    nextButton.classList.toggle('opacity-50', currentPage === totalPages);

    function addPageButton(pageNum) {
      const button = document.createElement('button');
      button.className = `pagination-number px-3 py-1 rounded-lg ${
        currentPage === pageNum 
          ? 'bg-orange-500 text-white' 
          : 'bg-gray-200 text-gray-700 hover:bg-gray-300'
      }`;
      button.textContent = pageNum;
      button.addEventListener('click', () => {
        currentPage = pageNum;
        filterAndDisplayRooms();
      });
      pageNumbers.appendChild(button);
    }

    function createEllipsis() {
      const span = document.createElement('span');
      span.className = 'px-2 text-gray-500';
      span.textContent = '...';
      return span;
    }
  }

  // Display current page of rooms
  function displayRooms() {
    const startIndex = (currentPage - 1) * roomsPerPage;
    const endIndex = startIndex + roomsPerPage;
    const visibleRooms = filteredRooms.slice(startIndex, endIndex);

    // Hide all rooms first
    allRooms.forEach(room => {
      room.style.display = 'none';
      room.classList.remove('animate-fadeIn');
    });

    // Show and animate filtered rooms for current page
    visibleRooms.forEach((room, index) => {
      room.style.display = 'block';
      // Add staggered animation
      setTimeout(() => {
        room.classList.add('animate-fadeIn');
      }, index * 100);
    });

    // Update room counter if it exists
    const roomCounter = document.getElementById('room-counter');
    if (roomCounter) {
      roomCounter.textContent = `Showing ${visibleRooms.length} of ${filteredRooms.length} rooms`;
    }
  }

  // Update no results message
  function updateNoResultsMessage() {
    const noResultsDiv = document.querySelector('.col-span-full');
    if (!noResultsDiv) return;

    if (filteredRooms.length === 0) {
      noResultsDiv.style.display = 'block';
      noResultsDiv.innerHTML = `
        <div class="text-gray-500 text-lg">No rooms found matching your criteria.</div>
        <p class="text-gray-400 mt-2">Try adjusting your filters or search terms.</p>
      `;
    } else {
      noResultsDiv.style.display = 'none';
    }
  }

  // Initialize pagination buttons
  document.querySelectorAll('.pagination-btn').forEach(button => {
    button.addEventListener('click', function() {
      if (this.disabled) return;
      
      if (this.dataset.page === 'prev' && currentPage > 1) {
        currentPage--;
      } else if (this.dataset.page === 'next' && currentPage < Math.ceil(filteredRooms.length / roomsPerPage)) {
        currentPage++;
      }
      filterAndDisplayRooms();
    });
  });

  // Add animation classes
  const style = document.createElement('style');
  style.textContent = `
    @keyframes fadeIn {
      from { opacity: 0; transform: translateY(10px); }
      to { opacity: 1; transform: translateY(0); }
    }
    .animate-fadeIn {
      animation: fadeIn 0.3s ease-out forwards;
    }
  `;
  document.head.appendChild(style);

  // Initial display
  filterAndDisplayRooms();

  // Handle room selection
  document.querySelectorAll('.select-room-btn').forEach(button => {
    button.addEventListener('click', function() {
      if (this.disabled) return;

      const roomData = {
        id: this.dataset.roomId,
        type: this.dataset.roomType,
        number: this.dataset.roomNumber,
        name: this.dataset.roomName,
        price: parseFloat(this.dataset.roomPrice)
      };

      // Remove selection from all rooms
      document.querySelectorAll('.room-card').forEach(card => {
        card.classList.remove('ring-2', 'ring-orange-500');
      });

      // Add selection to clicked room
      this.closest('.room-card').classList.add('ring-2', 'ring-orange-500');

      selectRoom(roomData);
    });
  });
});

// Function to validate date overlap with existing bookings
async function validateDateOverlap() {
  const roomSelect = document.getElementById('room-select');
  const checkIn = document.querySelector('input[name="check_in"]').value;
  const checkOut = document.querySelector('input[name="check_out"]').value;
  
  if (roomSelect.value && checkIn && checkOut) {
    const selectedOption = roomSelect.options[roomSelect.selectedIndex];
    const roomType = selectedOption.dataset.roomType;
    const roomNumber = selectedOption.textContent.match(/Room (\d+)/)[1];
    
    try {
      const response = await fetch(`/check-room-availability/${roomType}/${roomNumber}/?check_in=${checkIn}&check_out=${checkOut}`);
      const data = await response.json();
      
      const nextButton = document.querySelector('button[onclick="validateAndProceed()"]');
      if (!data.success) {
        nextButton.disabled = true;
        alert(data.message);
      } else {
        nextButton.disabled = false;
      }
    } catch (error) {
      console.error('Error checking availability:', error);
    }
  }
}

// Payment form submission with improved validation
function initializePaymentForm() {
  // Card number formatting and validation
  const cardNumber = document.getElementById('card-number');
  cardNumber.addEventListener('input', function(e) {
    let value = e.target.value.replace(/[^\d]/g, '');
    if (value.length > 16) value = value.slice(0, 16);
    
    // Format with spaces every 4 digits
    let formattedValue = '';
    for (let i = 0; i < value.length; i++) {
      if (i > 0 && i % 4 === 0) formattedValue += ' ';
      formattedValue += value[i];
    }
    e.target.value = formattedValue;
    
    // Validate card number using Luhn algorithm
    const isValid = validateCardNumber(value);
    cardNumber.classList.toggle('border-red-500', !isValid && value.length > 0);
    cardNumber.classList.toggle('border-green-500', isValid);
  });

  // Expiry date formatting and validation
  const cardExpiry = document.getElementById('card-expiry');
  cardExpiry.addEventListener('input', function(e) {
    let value = e.target.value.replace(/[^\d]/g, '');
    
    // Format as MM/YY
    if (value.length >= 2) {
      const month = parseInt(value.slice(0, 2));
      if (month > 12) value = '12' + value.slice(2);
      if (value.length > 2) value = value.slice(0, 2) + '/' + value.slice(2);
    }
    if (value.length > 5) value = value.slice(0, 5);
    e.target.value = value;
    
    // Validate expiry date
    const isValid = validateExpiryDate(value);
    cardExpiry.classList.toggle('border-red-500', !isValid && value.length > 0);
    cardExpiry.classList.toggle('border-green-500', isValid);
  });

  // CVV input validation
  const cardCvv = document.getElementById('card-cvv');
  cardCvv.addEventListener('input', function(e) {
    let value = e.target.value.replace(/[^\d]/g, '');
    if (value.length > 4) value = value.slice(0, 4);
    e.target.value = value;
    
    // Validate CVV length
    const isValid = value.length >= 3;
    cardCvv.classList.toggle('border-red-500', !isValid && value.length > 0);
    cardCvv.classList.toggle('border-green-500', isValid);
  });

  // Card holder name validation
  const cardName = document.getElementById('cardName');
  cardName.addEventListener('input', function(e) {
    const value = e.target.value;
    const isValid = /^[A-Za-z\s]{2,}$/.test(value); // At least 2 characters, letters and spaces only
    cardName.classList.toggle('border-red-500', !isValid && value.length > 0);
    cardName.classList.toggle('border-green-500', isValid);
  });

  // Helper function to validate card number using Luhn algorithm
  function validateCardNumber(number) {
    if (!number) return false;
    let sum = 0;
    let isEven = false;
    
    // Loop through values starting from the rightmost digit
    for (let i = number.length - 1; i >= 0; i--) {
      let digit = parseInt(number.charAt(i));
      
      if (isEven) {
        digit *= 2;
        if (digit > 9) {
          digit -= 9;
        }
      }
      
      sum += digit;
      isEven = !isEven;
    }
    
    return sum % 10 === 0;
  }

  // Helper function to validate expiry date
  function validateExpiryDate(value) {
    if (!value || value.length < 5) return false;
    
    const [month, year] = value.split('/');
    const expiry = new Date(2000 + parseInt(year), parseInt(month) - 1);
    const today = new Date();
    today.setDate(1); // Set to first of month for accurate month comparison
    
    return expiry > today;
  }

  // Payment form submission with improved validation
  const form = document.getElementById('paymentForm');
  const submitButton = document.getElementById('submit-button');
  const errorElement = document.getElementById('card-errors');

  form.addEventListener('submit', async function(event) {
    event.preventDefault();
    
    try {
      // Basic format validation
      const cardNumberValue = cardNumber.value.replace(/\s/g, '');
      const expiryValue = cardExpiry.value;
      const cvvValue = cardCvv.value;
      const nameValue = cardName.value;
      
      // Simple format checks for mock payment
      if (cardNumberValue.length < 12) {
        throw new Error('Card number must be at least 12 digits');
      }
      
      if (!expiryValue.includes('/')) {
        throw new Error('Invalid expiry date format (MM/YY)');
      }
      
      if (cvvValue.length < 3) {
        throw new Error('CVV must be at least 3 digits');
      }
      
      if (!nameValue.trim()) {
        throw new Error('Card holder name is required');
      }
      
      submitButton.disabled = true;
      submitButton.innerHTML = '<span class="inline-block animate-spin mr-2">â†»</span> Processing...';
      errorElement.textContent = '';
      
      // Get stored booking details
      const bookingDetails = JSON.parse(sessionStorage.getItem('bookingDetails'));
      
      // Final availability check
      const isAvailable = await checkRoomAvailability({
        type: bookingDetails.room_type,
        number: bookingDetails.room_number
      }, bookingDetails.check_in, bookingDetails.check_out);
      
      if (!isAvailable) {
        throw new Error('Room is no longer available');
      }
      
      // Get form data
      const formData = {
        booking_id: bookingDetails.room_id,
        card_data: {
          number: cardNumberValue,
          expiry: expiryValue,
          cvv: cvvValue,
          card_holder: nameValue,
          billing_address: document.getElementById('billingAddress').value
        },
        booking_details: {
          check_in: bookingDetails.check_in,
          check_out: bookingDetails.check_out,
          guest_count: parseInt(bookingDetails.guest_count),
          expected_arrival: bookingDetails.expected_arrival,
          total_amount: document.getElementById('finalAmount').textContent
        }
      };

      // For mock payment, simulate processing delay
      await new Promise(resolve => setTimeout(resolve, 1500));

      const response = await fetch('/process-payment/', {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json',
          'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]').value
        },
        body: JSON.stringify(formData)
      });
      
      const data = await response.json();
      
      if (!data.success) {
        throw new Error(data.error || 'Payment failed');
      }
      
      // Clear booking details
      sessionStorage.removeItem('bookingDetails');
      
      // Show success step
      nextStep();
      
    } catch (error) {
      errorElement.textContent = error.message;
      errorElement.classList.add('text-red-600', 'mt-2', 'text-sm');
      submitButton.disabled = false;
      submitButton.innerHTML = 'Pay now';
      
      if (error.message.includes('no longer available')) {
        setTimeout(() => {
          window.location.reload();
        }, 2000);
      }
    }
  });
}
</script>
{% endblock %}